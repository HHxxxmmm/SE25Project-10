# 准备提交订单功能说明

## 功能概述

准备提交订单功能是购票流程中的一个重要步骤，在用户确认购票之前，系统需要展示车次信息、席别信息、价格、余票情况以及用户关联的乘客信息，供用户选择和确认。

## 接口信息

### 接口地址
```
POST /api/prepare-order/prepare
```

### 请求参数
```json
{
  "userId": 1,
  "inventoryIds": [1, 2, 3]
}
```

- `userId`: 用户ID
- `inventoryIds`: 库存ID列表（最多3个，对应不同席别）

### 响应格式
```json
{
  "trainInfo": {
    "trainNumber": "G101",
    "departureStation": "北京南",
    "arrivalStation": "上海虹桥",
    "departureTime": "09:00:00",
    "arrivalTime": "14:30:00",
    "travelDate": "2025-07-08"
  },
  "carriages": [
    {
      "inventoryId": 1,
      "carriageTypeName": "商务座",
      "price": 553.00,
      "hasStock": true,
      "availableStock": 10
    },
    {
      "inventoryId": 2,
      "carriageTypeName": "一等座",
      "price": 553.00,
      "hasStock": true,
      "availableStock": 20
    },
    {
      "inventoryId": 3,
      "carriageTypeName": "二等座",
      "price": 553.00,
      "hasStock": false,
      "availableStock": 0
    }
  ],
  "passengers": [
    {
      "passengerId": 1,
      "realName": "张三",
      "idCardNumber": "110101199001011234",
      "phoneNumber": "13800138000",
      "passengerType": 1,
      "passengerTypeName": "成人",
      "relationType": 1,
      "relationTypeName": "本人"
    }
  ]
}
```

## 功能特点

### 1. 车次信息展示
- 车次号
- 出发站和到达站
- 出发时间和到达时间
- 出发日期

### 2. 席别信息展示
- 席别名称
- 价格
- 余票情况（从Redis获取）
- 可用库存数量

### 3. 乘客信息展示
- 用户关联的所有乘客信息
- 乘客类型（成人、儿童、学生、残疾、军人）
- 关系类型（本人、亲属、其他）
- 身份证号和手机号

### 4. Redis库存管理
- 系统启动时会将数据库库存初始化到Redis
- 正式下单时使用Redis预扣减库存
- 回滚操作也在Redis上先完成
- 定时同步Redis和数据库的库存数据

## 库存Key格式
```
stock:{trainId}:{departureStopId}:{arrivalStopId}:{travelDate}:{carriageTypeId}
```

例如：`stock:98:486:490:2025-07-08:6`

## 测试用例

### 1. 正常情况
- 用户ID: 1
- 库存ID: [1, 2, 3]
- 预期：返回完整的车次、席别、乘客信息

### 2. 用户不存在
- 用户ID: 999
- 预期：返回400错误

### 3. 库存不存在
- 库存ID: [999, 998, 997]
- 预期：返回400错误

### 4. 空库存列表
- 库存ID: []
- 预期：返回400错误

### 5. 用户6（有3个关联乘客）
- 用户ID: 6
- 预期：返回3个乘客信息

### 6. 用户10（关联乘客较少）
- 用户ID: 10
- 预期：返回较少的乘客信息

## 技术实现

### 1. 数据流程
1. 根据inventoryIds获取库存信息
2. 根据库存信息获取车次、站点、席别信息
3. 从Redis获取实时库存数据
4. 获取用户关联的乘客信息
5. 组装响应数据

### 2. 错误处理
- 库存不存在时抛出异常
- 车次信息不存在时抛出异常
- 站点信息不存在时抛出异常
- 席别信息不存在时抛出异常
- 乘客信息不存在时抛出异常

### 3. Redis集成
- 优先从Redis获取库存数据
- 如果Redis中没有数据，则使用数据库中的可用座位数
- 确保库存数据的实时性和准确性

## 使用场景

1. **用户选择车次和席别后**：系统展示详细信息供用户确认
2. **用户选择乘客前**：展示可选的乘客列表
3. **订单确认前**：展示最终的价格和余票情况

这个功能为后续的正式下单提供了必要的信息准备，确保用户能够做出正确的购票决策。 