# 订单详情功能说明

## 功能概述

订单详情功能允许用户查看单个订单的完整信息，包括订单基本信息、车次信息和所有车票的详细信息。该功能包含权限验证，确保用户只能查看属于自己的订单。

## API接口

### 获取订单详情

**接口地址**: `GET /api/orders/detail`

**请求参数**:
- `userId` (Long, 必需): 用户ID
- `orderId` (Long, 必需): 订单ID

**请求示例**:
```
GET /api/orders/detail?userId=1&orderId=1
```

**响应格式**:
```json
{
  "orderNumber": "202501010001",
  "orderStatus": 1,
  "orderTime": "2025-01-01T10:30:00",
  "paymentTime": "2025-01-01T10:35:00",
  "paymentMethod": "支付宝",
  "totalAmount": 299.50,
  "trainNumber": "G1",
  "travelDate": "2025-07-01",
  "departureTime": "08:00:00",
  "arrivalTime": "10:30:00",
  "departureStation": "北京南站",
  "arrivalStation": "上海虹桥站",
  "tickets": [
    {
      "ticketId": 1,
      "ticketNumber": "T202501010001001",
      "passengerName": "张三",
      "idCardNumber": "110101199001011234",
      "passengerType": 1,
      "ticketType": 1,
      "carriageType": "二等座",
      "carriageNumber": "08",
      "seatNumber": "12A",
      "price": 299.50,
      "ticketStatus": 1
    }
  ]
}
```

## 功能特点

### 1. 权限验证
- 系统会验证订单是否属于指定用户
- 如果订单不存在或不属于该用户，返回错误信息
- 确保数据安全性

### 2. 数据完整性
- 返回订单的所有基本信息（包括订单号）
- 包含车次信息（所有车票共享相同信息）
- 列出订单中的所有车票详情（包括车票ID）

### 3. 车票信息简约化
- 由于同一订单内的车票具有相同的车次、出发到达站、时间等信息
- 车票详情只包含差异化的信息：
  - 车票ID（用于后续操作）
  - 车票号
  - 乘客信息（姓名、身份证号、乘客类型）
  - 票种信息
  - 座位信息（席别、车厢号、座位号）
  - 价格信息
  - 车票状态

### 4. 车次信息共享
- 所有车票共享相同的车次信息：
  - 车次号
  - 出发日期
  - 出发/到达时间
  - 出发/到达站
- 避免重复数据，提高响应效率

## 数据字段说明

### 订单基本信息
- `orderNumber`: 订单号
- `orderStatus`: 订单状态（0-待支付, 1-已支付, 2-已完成, 3-已取消）
- `orderTime`: 下单时间
- `paymentTime`: 支付时间
- `paymentMethod`: 支付方式
- `totalAmount`: 订单总金额

### 车次信息
- `trainNumber`: 车次号
- `travelDate`: 出发日期
- `departureTime`: 出发时间
- `arrivalTime`: 到达时间
- `departureStation`: 出发站
- `arrivalStation`: 到达站

### 车票信息
- `ticketId`: 车票ID（用于后续操作如退票、改签等）
- `ticketNumber`: 车票号
- `passengerName`: 乘客姓名
- `idCardNumber`: 身份证号
- `passengerType`: 乘客类型（1-成人, 2-儿童, 3-学生, 4-残疾军人）
- `ticketType`: 票种（1-成人, 2-儿童, 3-学生, 4-残疾, 5-军人）
- `carriageType`: 席别名称
- `carriageNumber`: 车厢号
- `seatNumber`: 座位号
- `price`: 票价
- `ticketStatus`: 车票状态（0-待支付, 1-未使用, 2-已使用, 3-已退票, 4-已改签）

## 错误处理

### 常见错误
1. **订单不存在**: 订单ID无效
2. **权限不足**: 订单不属于指定用户
3. **订单无车票**: 订单中没有车票信息
4. **车次信息缺失**: 关联的车次信息不存在

### 错误响应示例
```json
{
  "error": "订单不存在或不属于该用户"
}
```

## 使用场景

1. **订单详情页面**: 用户点击订单列表中的某个订单，查看详细信息
2. **订单管理**: 管理员查看订单详情进行管理
3. **客服支持**: 客服人员查看订单详情处理用户问题
4. **数据统计**: 系统内部统计订单和车票信息
5. **后续操作**: 基于车票ID进行退票、改签等操作

## 性能优化

1. **数据库查询优化**: 使用JOIN查询减少数据库访问次数
2. **数据去重**: 车次信息只查询一次，避免重复
3. **权限验证**: 在查询时直接验证权限，避免额外的查询
4. **异常处理**: 完善的异常处理机制，提供友好的错误信息

## 测试用例

### 正常情况测试
- 用户查看自己的订单详情
- 订单包含多张车票的情况
- 不同订单状态的情况

### 异常情况测试
- 订单ID不存在
- 订单不属于指定用户
- 订单中没有车票信息
- 车次信息缺失

### 边界情况测试
- 订单只有一张车票
- 订单包含大量车票
- 车票状态为各种状态的情况 