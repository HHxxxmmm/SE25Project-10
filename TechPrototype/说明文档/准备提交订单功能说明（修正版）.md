# 准备提交订单功能说明（修正版）

## 功能概述

准备提交订单功能是购票流程中的一个重要步骤，在用户确认购票之前，系统需要展示车次信息、席别信息、价格、余票情况以及用户关联的乘客信息，供用户选择和确认。

## 数据结构理解

### 1. 车次和区间关系
- **车次（Train）**: 如G101、D102等
- **区间（TrainStop）**: 车次在特定站点的停靠信息
- **库存（TicketInventory）**: 基于车次+出发区间+到达区间+日期+席别的库存信息

### 2. 数据表关系
```
trains (车次表)
  ↓ train_id
train_stops (车次停靠表)
  ↓ stop_id
ticket_inventory (库存表) ← departure_stop_id, arrival_stop_id
  ↓ station_id
stations (站点表)
```

### 3. 库存Key格式
```
stock:{trainId}:{departureStopId}:{arrivalStopId}:{travelDate}:{carriageTypeId}
```

## 接口信息

### 接口地址
```
POST /api/prepare-order/prepare
```

### 请求参数
```json
{
  "userId": 1,
  "inventoryIds": [1, 11, 21]
}
```

- `userId`: 用户ID
- `inventoryIds`: 库存ID列表（通常为3个，对应同一车次同一区间同一日期的所有席别）

### 响应格式
```json
{
  "trainInfo": {
    "trainNumber": "G101",
    "departureStation": "北京西",
    "arrivalStation": "上海虹桥",
    "departureTime": "08:00:00",
    "arrivalTime": "12:30:00",
    "travelDate": "2025-07-01"
  },
  "carriages": [
    {
      "inventoryId": 1,
      "carriageTypeName": "商务座",
      "price": 560.00,
      "hasStock": true,
      "availableStock": 30
    },
    {
      "inventoryId": 11,
      "carriageTypeName": "一等座",
      "price": 480.00,
      "hasStock": true,
      "availableStock": 60
    },
    {
      "inventoryId": 21,
      "carriageTypeName": "二等座",
      "price": 320.00,
      "hasStock": false,
      "availableStock": 0
    }
  ],
  "passengers": [
    {
      "passengerId": 1,
      "realName": "张三",
      "idCardNumber": "110101199001011234",
      "phoneNumber": "13800138000",
      "passengerType": 1,
      "passengerTypeName": "成人",
      "relationType": 1,
      "relationTypeName": "本人"
    }
  ]
}
```

## 功能特点

### 1. 车次信息展示
- **车次号**: 从trains表获取
- **出发站**: 从train_stops表获取departure_stop_id对应的station_id，再从stations表获取站名
- **到达站**: 从train_stops表获取arrival_stop_id对应的station_id，再从stations表获取站名
- **出发时间**: 从train_stops表获取departure_time
- **到达时间**: 从train_stops表获取arrival_time
- **出发日期**: 从ticket_inventory表获取travel_date

### 2. 席别信息展示
- **席别名称**: 从carriage_types表获取
- **价格**: 从ticket_inventory表获取
- **余票情况**: 从Redis获取实时库存数据
- **可用库存数量**: 从Redis获取，如果Redis没有则使用数据库中的available_seats

### 3. 乘客信息展示
- 用户关联的所有乘客信息
- 乘客类型（成人、儿童、学生、残疾、军人）
- 关系类型（本人、亲属、其他）
- 身份证号和手机号

### 4. Redis库存管理
- 系统启动时会将数据库库存初始化到Redis
- 正式下单时使用Redis预扣减库存
- 回滚操作也在Redis上先完成
- 定时同步Redis和数据库的库存数据

## 测试用例

### 1. 正常情况
- **G101所有席别**: `inventoryIds: [1, 11, 21]` - 商务座、一等座、二等座
- **D102所有席别**: `inventoryIds: [4, 14, 24]` - 硬座、硬卧、无座
- **G103所有席别**: `inventoryIds: [7, 17, 27]` - 二等座、硬座
- **K240区间1所有席别**: `inventoryIds: [100, 110, 120]`
- **K240区间2所有席别**: `inventoryIds: [101, 111, 121]`

### 2. 错误情况
- **用户不存在**: `userId: 999`
- **库存不存在**: `inventoryIds: [999, 998, 997]`
- **空库存列表**: `inventoryIds: []`

### 3. 用户乘客测试
- **用户6**: 有3个关联乘客
- **用户10**: 关联乘客较少

## 技术实现

### 1. 数据流程
1. 根据inventoryIds获取库存信息
2. 根据库存信息获取车次、站点、席别信息
3. 从Redis获取实时库存数据
4. 获取用户关联的乘客信息
5. 组装响应数据

### 2. 错误处理
- 库存不存在时抛出异常
- 车次信息不存在时抛出异常
- 站点信息不存在时抛出异常
- 席别信息不存在时抛出异常
- 乘客信息不存在时抛出异常

### 3. Redis集成
- 优先从Redis获取库存数据
- 如果Redis中没有数据，则使用数据库中的可用座位数
- 确保库存数据的实时性和准确性

## 使用场景

1. **用户选择车次和区间后**: 系统展示该车次该区间的所有席别信息
2. **用户选择乘客前**: 展示可选的乘客列表
3. **订单确认前**: 展示最终的价格和余票情况

## 数据验证规则

1. **库存ID验证**: 所有inventoryIds必须存在
2. **用户验证**: 用户必须存在且有效
3. **乘客验证**: 用户关联的乘客信息必须完整

## 注意事项

1. **前端责任**: 前端负责确保传递的inventoryIds属于同一车次、同一区间、同一日期
2. **后端简化**: 后端不验证inventoryIds的一致性，直接处理传入的数据
3. **席别展示**: 系统会展示所有传入inventoryIds对应的席别信息，供用户选择

这个功能为后续的正式下单提供了必要的信息准备，确保用户能够做出正确的购票决策。 