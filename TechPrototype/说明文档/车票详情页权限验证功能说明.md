# 车票详情页权限验证功能说明

## 功能概述

为车票详情页添加了权限验证逻辑，确保用户只能查看自己相关的车票。该功能实现了"或"逻辑的权限验证，满足以下任一条件即可访问车票详情：

1. 车票的乘客ID与用户的乘客ID一致
2. 车票所属订单的用户ID与当前用户ID一致

## 权限验证逻辑

### 验证条件

#### 条件1：乘客身份验证
- **逻辑**：`ticket.passengerId == user.passengerId`
- **说明**：用户直接关联的乘客ID与车票的乘客ID一致
- **适用场景**：用户查看自己的车票（本人车票页面）

#### 条件2：订单所有者验证
- **逻辑**：`ticket.orderId -> order.userId == currentUserId`
- **说明**：车票所属订单的用户ID与当前用户ID一致
- **适用场景**：用户查看自己订单中的车票（订单详情页面）

### 验证流程

```java
// 权限验证逻辑
boolean hasPermission = false;

// 检查条件1：车票的乘客ID与用户的乘客ID一致
if (user.getPassengerId() != null && user.getPassengerId().equals(ticket.getPassengerId())) {
    hasPermission = true;
    System.out.println("权限验证通过：车票乘客ID与用户乘客ID一致");
}

// 检查条件2：车票所属订单的用户ID与当前用户ID一致
if (!hasPermission) {
    Optional<Order> orderOpt = orderRepository.findById(ticket.getOrderId());
    if (orderOpt.isPresent() && orderOpt.get().getUserId().equals(userId)) {
        hasPermission = true;
        System.out.println("权限验证通过：车票所属订单用户ID与当前用户ID一致");
    }
}

if (!hasPermission) {
    return TicketDetailResponse.failure("无权限查看该车票详情");
}
```

## 数据库设计

### 相关表结构

#### users表
```sql
CREATE TABLE users (
    user_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    passenger_id BIGINT NULL,  -- 关联的乘客ID
    -- 其他字段...
    CONSTRAINT fk_user_passenger FOREIGN KEY (passenger_id) REFERENCES passengers (passenger_id)
);
```

#### tickets表
```sql
CREATE TABLE tickets (
    ticket_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    passenger_id BIGINT NOT NULL,  -- 车票的乘客ID
    order_id BIGINT NOT NULL,      -- 车票所属订单ID
    -- 其他字段...
    CONSTRAINT fk_tickets_passenger FOREIGN KEY (passenger_id) REFERENCES passengers (passenger_id),
    CONSTRAINT fk_tickets_order FOREIGN KEY (order_id) REFERENCES orders (order_id)
);
```

#### orders表
```sql
CREATE TABLE orders (
    order_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,  -- 订单的用户ID
    -- 其他字段...
    CONSTRAINT fk_orders_user FOREIGN KEY (user_id) REFERENCES users (user_id)
);
```

## API接口设计

### 车票详情接口

**接口地址**: `GET /api/ticket/detail`

**请求参数**:
- `ticketId` (Long): 车票ID
- `userId` (Long): 用户ID

**示例请求**:
```
GET /api/ticket/detail?ticketId=1&userId=1
```

**响应示例**:
```json
{
  "status": "SUCCESS",
  "message": "获取成功",
  "ticket": {
    "ticketId": 1,
    "ticketNumber": "T123456789",
    "orderId": 1,
    "orderNumber": "O123456789",
    "trainId": 1,
    "trainNumber": "G1",
    "departureStopId": 1,
    "departureStationName": "北京南站",
    "departureCity": "北京",
    "arrivalStopId": 2,
    "arrivalStationName": "上海虹桥站",
    "arrivalCity": "上海",
    "travelDate": "2025-07-01",
    "carriageNumber": "01",
    "seatNumber": "1A",
    "price": 553.50,
    "ticketStatus": 1,
    "ticketStatusText": "未使用",
    "ticketType": 1,
    "ticketTypeText": "成人票",
    "createdTime": "2025-06-30T10:30:00",
    "paymentTime": "2025-06-30T10:35:00",
    "orderStatusText": "已支付",
    "passengerName": "张三",
    "passengerIdCard": "110101199001011234",
    "passengerPhone": "13800138000",
    "passengerType": 1,
    "passengerTypeText": "成人",
    "digitalSignature": "abc123...",
    "runningDays": 1,
    "carriageTypeId": 3,
    "carriageTypeName": "二等座"
  },
  "timestamp": "2025-06-30T15:30:00"
}
```

## 业务逻辑实现

### Service层实现

在 `TicketServiceImpl` 中实现了 `getTicketDetail` 方法：

```java
@Override
public TicketDetailResponse getTicketDetail(Long ticketId, Long userId) {
    try {
        // 1. 根据车票ID查询车票信息
        Optional<Ticket> ticketOpt = ticketRepository.findById(ticketId);
        if (!ticketOpt.isPresent()) {
            return TicketDetailResponse.failure("车票不存在");
        }
        
        Ticket ticket = ticketOpt.get();
        
        // 2. 根据用户ID查询用户信息
        Optional<User> userOpt = userRepository.findById(userId);
        if (!userOpt.isPresent()) {
            return TicketDetailResponse.failure("用户不存在");
        }
        
        User user = userOpt.get();
        
        // 3. 权限验证逻辑
        boolean hasPermission = false;
        
        // 检查条件1：车票的乘客ID与用户的乘客ID一致
        if (user.getPassengerId() != null && user.getPassengerId().equals(ticket.getPassengerId())) {
            hasPermission = true;
            System.out.println("权限验证通过：车票乘客ID与用户乘客ID一致");
        }
        
        // 检查条件2：车票所属订单的用户ID与当前用户ID一致
        if (!hasPermission) {
            Optional<Order> orderOpt = orderRepository.findById(ticket.getOrderId());
            if (orderOpt.isPresent() && orderOpt.get().getUserId().equals(userId)) {
                hasPermission = true;
                System.out.println("权限验证通过：车票所属订单用户ID与当前用户ID一致");
            }
        }
        
        if (!hasPermission) {
            return TicketDetailResponse.failure("无权限查看该车票详情");
        }
        
        // 4. 获取相关数据并构建响应
        // ... 获取订单、乘客、车站等信息
        
        return TicketDetailResponse.success(ticketDetail);
        
    } catch (Exception e) {
        System.err.println("获取车票详情失败: " + e.getMessage());
        return TicketDetailResponse.failure("获取车票详情失败: " + e.getMessage());
    }
}
```

### Controller层实现

在 `TicketController` 中添加了API端点：

```java
@GetMapping("/detail")
public ResponseEntity<TicketDetailResponse> getTicketDetail(
        @RequestParam Long ticketId,
        @RequestParam Long userId) {
    TicketDetailResponse response = ticketService.getTicketDetail(ticketId, userId);
    if ("SUCCESS".equals(response.getStatus())) {
        return ResponseEntity.ok(response);
    } else {
        return ResponseEntity.badRequest().body(response);
    }
}
```

## 数据传输对象

### TicketDetailResponse

创建了专门的车票详情响应DTO：

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class TicketDetailResponse {
    
    private String status;
    private String message;
    private TicketDetailInfo ticket;
    private LocalDateTime timestamp;
    
    @Data
    @NoArgsConstructor
    @AllArgsConstructor
    public static class TicketDetailInfo {
        // 车票基本信息
        private Long ticketId;
        private String ticketNumber;
        private Long orderId;
        private String orderNumber;
        
        // 车次信息
        private Integer trainId;
        private String trainNumber;
        
        // 车站信息
        private Long departureStopId;
        private String departureStationName;
        private String departureCity;
        private Long arrivalStopId;
        private String arrivalStationName;
        private String arrivalCity;
        
        // 车票详情
        private LocalDate travelDate;
        private String carriageNumber;
        private String seatNumber;
        private BigDecimal price;
        private Byte ticketStatus;
        private String ticketStatusText;
        private Byte ticketType;
        private String ticketTypeText;
        
        // 时间信息
        private LocalDateTime createdTime;
        private LocalDateTime paymentTime;
        private String orderStatusText;
        
        // 乘客信息
        private String passengerName;
        private String passengerIdCard;
        private String passengerPhone;
        private Byte passengerType;
        private String passengerTypeText;
        
        // 其他信息
        private String digitalSignature;
        private Integer runningDays;
        private Integer carriageTypeId;
        private String carriageTypeName;
    }
}
```

## 错误处理

### 1. 车票不存在
- 错误信息：`"车票不存在"`
- 处理方式：检查车票ID是否有效

### 2. 用户不存在
- 错误信息：`"用户不存在"`
- 处理方式：检查用户ID是否有效

### 3. 权限不足
- 错误信息：`"无权限查看该车票详情"`
- 处理方式：权限验证失败时返回

### 4. 数据异常
- 错误信息：`"获取车票详情失败: " + 具体错误信息`
- 处理方式：捕获异常并返回友好提示

## 前端集成建议

### 1. 页面跳转逻辑
- 从本人车票页面跳转：使用车票ID和用户ID
- 从订单详情页面跳转：使用车票ID和用户ID
- 支持直接URL访问（需要验证权限）

### 2. 权限处理
- 前端无需额外权限验证，依赖后端验证
- 权限不足时显示错误提示页面
- 支持返回上一页或跳转到首页

### 3. 数据展示
- 展示完整的车票信息
- 支持车票状态的可视化显示
- 提供车票操作按钮（如退票、改签等）

### 4. 用户体验
- 加载状态提示
- 错误信息友好展示
- 支持页面刷新

## 测试用例

### Postman测试集合

已更新 `postman_collection.json`，添加了车票详情API测试：

1. **获取车票详情**
   - 接口：`GET /api/ticket/detail`
   - 参数：ticketId=1, userId=1

### 测试场景

1. **正常访问场景**
   - 用户查看自己的车票（乘客ID匹配）
   - 用户查看自己订单中的车票（订单用户ID匹配）

2. **权限验证测试**
   - 尝试访问其他用户的车票（应该失败）
   - 尝试访问不存在的车票（应该失败）
   - 尝试使用不存在的用户ID（应该失败）

3. **边界值测试**
   - 使用无效的车票ID
   - 使用无效的用户ID
   - 使用null值

4. **数据完整性测试**
   - 验证返回的车票信息完整性
   - 验证关联数据的正确性

## 安全考虑

### 1. 权限验证
- 严格的权限验证逻辑
- 防止越权访问
- 详细的权限验证日志

### 2. 数据保护
- 敏感信息脱敏处理
- 身份证号等隐私信息保护
- 防止SQL注入

### 3. 访问控制
- 基于用户身份的访问控制
- 防止恶意访问
- 请求频率限制

## 性能优化

### 1. 数据库查询优化
- 使用索引优化查询性能
- 减少不必要的数据库查询
- 合理使用关联查询

### 2. 缓存策略
- 考虑对车票详情进行缓存
- 缓存用户权限信息
- 减少重复查询

### 3. 响应优化
- 异步加载非关键信息
- 分页加载大量数据
- 压缩响应数据

## 总结

车票详情页权限验证功能实现了灵活的权限控制机制，支持两种验证方式：

1. **乘客身份验证**：适用于本人车票页面
2. **订单所有者验证**：适用于订单详情页面

该功能具有以下特点：

1. **安全性高**：严格的权限验证，防止越权访问
2. **灵活性好**：支持多种访问场景
3. **用户体验佳**：清晰的错误提示和友好的界面
4. **扩展性强**：易于添加新的权限验证规则
5. **性能优良**：优化的数据库查询和缓存策略

该功能已完全集成到现有系统中，为车票详情页提供了可靠的权限保护机制。 