# 本人车票功能实现说明

## 功能概述

根据新的数据库结构设计，用户现在直接关联到乘客ID（`users.passenger_id`），实现了本人车票查询功能。用户可以在前端"本人车票"页面查看属于自己（关联乘客）的所有车票。

## 数据库变更

### users表变更
- 移除了 `id_card_number` 字段
- 新增 `related_passenger` 字段：记录用户关联的乘客数量
- 新增 `passenger_id` 字段：直接关联到 `passengers` 表的乘客ID
- 新增外键约束 `fk_user_passenger`

### passengers表变更
- 新增 `student_type_left` 字段：学生票剩余次数
- 学生类型乘客初始为4，其他类型为0

## 功能实现

### 1. 数据访问层 (Repository)

在 `TicketRepository` 中新增了以下查询方法：

```java
// 根据乘客ID查询所有车票（按创建时间倒序）
@Query("SELECT t FROM Ticket t WHERE t.passengerId = :passengerId ORDER BY t.createdTime DESC")
List<Ticket> findByPassengerIdOrderByCreatedTimeDesc(@Param("passengerId") Long passengerId);

// 根据乘客ID查询有效车票（待支付、未使用、已使用状态）
@Query("SELECT t FROM Ticket t WHERE t.passengerId = :passengerId AND t.ticketStatus IN (0, 1, 2) ORDER BY t.createdTime DESC")
List<Ticket> findValidTicketsByPassengerId(@Param("passengerId") Long passengerId);

// 根据乘客ID和车票状态查询车票（按创建时间倒序）
@Query("SELECT t FROM Ticket t WHERE t.passengerId = :passengerId AND t.ticketStatus = :ticketStatus ORDER BY t.createdTime DESC")
List<Ticket> findByPassengerIdAndTicketStatusOrderByCreatedTimeDesc(
        @Param("passengerId") Long passengerId, 
        @Param("ticketStatus") byte ticketStatus);
```

### 2. 数据传输对象 (DTO)

创建了 `MyTicketResponse` 类来封装本人车票的响应数据：

```java
public class MyTicketResponse {
    private String status;
    private String message;
    private List<MyTicketInfo> tickets;
    private LocalDateTime timestamp;
    
    public static class MyTicketInfo {
        private Long ticketId;
        private String ticketNumber;
        private Long orderId;
        private String orderNumber;
        private Integer trainId;
        private String trainNumber;
        private Long departureStopId;
        private String departureStationName;
        private Long arrivalStopId;
        private String arrivalStationName;
        private LocalDate travelDate;
        private String carriageNumber;
        private String seatNumber;
        private BigDecimal price;
        private Byte ticketStatus;
        private String ticketStatusText;
        private Byte ticketType;
        private String ticketTypeText;
        private LocalDateTime createdTime;
        private LocalDateTime paymentTime;
        private String orderStatusText;
    }
}
```

### 3. 服务层 (Service)

在 `TicketService` 接口中新增了以下方法：

```java
/**
 * 获取本人车票
 */
MyTicketResponse getMyTickets(Long userId);

/**
 * 根据车票状态获取本人车票
 */
MyTicketResponse getMyTicketsByStatus(Long userId, Byte ticketStatus);
```

在 `TicketServiceImpl` 中实现了这些方法：

#### 获取本人车票流程
1. 根据用户ID查找用户信息
2. 获取用户关联的乘客ID
3. 根据乘客ID查询所有有效车票
4. 转换为响应格式，包含详细信息

#### 数据转换
- 获取订单信息（订单号、支付时间、订单状态）
- 获取车站信息（出发站、到达站名称）
- 获取车次信息（车次号）
- 转换状态文本（车票状态、票种、订单状态）

### 4. 控制器层 (Controller)

在 `TicketController` 中新增了以下接口：

```java
/**
 * 获取本人车票
 */
@GetMapping("/my-tickets")
public ResponseEntity<MyTicketResponse> getMyTickets(@RequestParam Long userId)

/**
 * 根据状态获取本人车票
 */
@GetMapping("/my-tickets/status")
public ResponseEntity<MyTicketResponse> getMyTicketsByStatus(
        @RequestParam Long userId, 
        @RequestParam Byte ticketStatus)
```

## API接口

### 1. 获取本人车票
```
GET /api/ticket/my-tickets?userId=1
```

**功能**：获取用户关联乘客的所有有效车票
**参数**：
- `userId`：用户ID

**返回**：所有有效车票（待支付、未使用、已使用状态）

### 2. 根据状态获取本人车票
```
GET /api/ticket/my-tickets/status?userId=1&ticketStatus=0
```

**功能**：根据车票状态获取本人车票
**参数**：
- `userId`：用户ID
- `ticketStatus`：车票状态
  - 0: 待支付
  - 1: 未使用
  - 2: 已使用
  - 3: 已退票
  - 4: 已改签

**返回**：指定状态的车票列表

## 响应数据格式

```json
{
  "status": "SUCCESS",
  "message": "获取成功",
  "tickets": [
    {
      "ticketId": 1,
      "ticketNumber": "T123456789",
      "orderId": 1,
      "orderNumber": "O123456789",
      "trainId": 1,
      "trainNumber": "G1",
      "departureStopId": 1,
      "departureStationName": "北京南站",
      "arrivalStopId": 2,
      "arrivalStationName": "上海虹桥站",
      "travelDate": "2025-07-01",
      "carriageNumber": "01",
      "seatNumber": "1A",
      "price": 553.50,
      "ticketStatus": 0,
      "ticketStatusText": "待支付",
      "ticketType": 1,
      "ticketTypeText": "成人票",
      "createdTime": "2025-06-30T10:30:00",
      "paymentTime": "2025-06-30T10:35:00",
      "orderStatusText": "已支付"
    }
  ],
  "timestamp": "2025-06-30T15:30:00"
}
```

## 前端集成

### 使用场景
1. **本人车票页面**：显示用户的所有有效车票
2. **车票状态分类**：按状态筛选显示不同状态的车票（待支付、未使用、已使用、已退票、已改签）
3. **车票详情展示**：显示车票的完整信息

### 调用示例
```javascript
// 获取所有本人车票
fetch('/api/ticket/my-tickets?userId=1')
  .then(response => response.json())
  .then(data => {
    if (data.status === 'SUCCESS') {
      // 处理车票数据
      console.log(data.tickets);
    }
  });

// 获取待支付的车票
fetch('/api/ticket/my-tickets/status?userId=1&ticketStatus=0')
  .then(response => response.json())
  .then(data => {
    if (data.status === 'SUCCESS') {
      // 处理待支付车票数据
      console.log(data.tickets);
    }
  });
```

## 注意事项

1. **用户乘客关联**：用户必须关联到乘客才能查询车票
2. **数据完整性**：返回的车票信息包含完整的订单、车站、车次信息
3. **状态管理**：支持按车票状态筛选（待支付、未使用、已使用、已退票、已改签），便于前端分类展示
4. **排序规则**：车票按创建时间倒序排列，最新的车票在前
5. **错误处理**：完善的错误处理机制，返回友好的错误信息

## 测试

已更新Postman集合，新增"7. 本人车票管理"部分，包含：
- 获取本人车票接口测试
- 根据状态获取本人车票接口测试

可以通过Postman直接测试这些接口的功能。 