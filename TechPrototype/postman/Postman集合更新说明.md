# Postman集合更新说明

## 更新概述

根据当前后端API结构和前端需求，对 `postman_collection.json` 文件进行了重要更新，主要解决了购票请求中缺少 `carriageTypeId` 字段的问题，并添加了准备提交订单API。

## 主要更新内容

### 1. 新增准备提交订单API

**新增章节**: "0. 准备提交订单"

**API信息**:
- **接口地址**: `POST /api/prepare-order/prepare`
- **请求参数**:
```json
{
  "userId": 1,
  "inventoryIds": [1, 11, 21]
}
```
- **功能说明**: 
  - 根据用户ID和库存ID列表获取订单准备信息
  - 返回车次信息、席别信息、价格、余票情况
  - 返回用户关联的乘客信息
  - 前端使用此接口获取提交订单页面的所有数据

### 2. 修复购票请求结构

**问题**: 原购票请求中乘客信息缺少 `carriageTypeId` 字段，导致后端报错 "carriageTypeId null"

**修复**: 在所有购票请求的乘客数组中添加了 `carriageTypeId` 字段

**修复前**:
```json
{
  "passengers": [
    {
      "passengerId": 319,
      "ticketType": 1
    }
  ]
}
```

**修复后**:
```json
{
  "passengers": [
    {
      "passengerId": 319,
      "ticketType": 1,
      "carriageTypeId": 3
    }
  ]
}
```

### 3. 更新的购票测试用例

#### 3.1 购票 - 成人票
- 添加了 `carriageTypeId: 3` 到乘客信息
- 使用二等座确保库存充足

#### 3.2 购票 - 多人票
- 为每个乘客添加了 `carriageTypeId: 3`
- 支持不同票种（成人票、儿童票）

#### 3.3 购票 - 不同区间
- 添加了 `carriageTypeId: 3` 到乘客信息
- 测试不同出发站和到达站组合

#### 3.4 购票 - 不同座位类型
- 添加了 `carriageTypeId: 3` 到乘客信息
- 测试不同车厢类型

### 4. 更新说明文档

为每个购票测试用例添加了说明：
- 强调每个乘客必须包含 `carriageTypeId` 字段
- 说明票种类型和车厢类型的关系
- 提供测试参数说明

## 技术细节

### 后端API结构
根据 `BookingRequest.java` 的定义，每个乘客信息必须包含：
- `passengerId`: 乘客ID
- `ticketType`: 票种（1-成人, 2-儿童, 3-学生, 4-残疾, 5-军人）
- `carriageTypeId`: 车厢类型ID（1-商务座, 2-一等座, 3-二等座等）

### 库存Key格式
```
stock:{trainId}:{departureStopId}:{arrivalStopId}:{travelDate}:{carriageTypeId}
```

### 测试参数
- **用户ID**: 1
- **库存ID**: [1, 11, 21]（对应同一车次同一区间同一日期的所有席别）
- **车厢类型ID**: 3（二等座）

## 测试建议

### 1. 准备提交订单测试
1. 使用 "0. 准备提交订单" 接口
2. 验证返回的车次信息、席别信息、乘客信息
3. 确认价格和余票情况正确

### 2. 购票流程测试
1. 先调用准备提交订单接口获取数据
2. 使用修复后的购票接口进行购票
3. 验证订单创建成功
4. 进行支付操作

### 3. 错误处理测试
1. 测试缺少 `carriageTypeId` 的错误情况
2. 测试无效乘客ID的错误情况
3. 测试库存不足的错误情况

## 注意事项

1. **carriageTypeId 必填**: 所有购票请求中的乘客信息必须包含 `carriageTypeId` 字段
2. **库存验证**: 系统会根据 `carriageTypeId` 检查对应席别的库存
3. **乘客关系**: 乘客ID必须与用户ID有关联关系
4. **时间冲突**: 系统会检查同一乘客在同一时间段是否有其他车票

## 后续优化

1. **支持独立席别**: 未来可以考虑支持每个乘客选择不同的席别
2. **动态库存**: 根据实际库存情况动态调整可用席别
3. **价格计算**: 根据票种和席别动态计算票价
4. **并发控制**: 加强高并发场景下的库存控制 