# 退票功能完整测试说明

## 功能概述

退票功能分为两个阶段：
1. **退票准备阶段**：进入退票页面，获取订单和车票信息
2. **正式退票阶段**：用户选择车票后，执行退票操作

## 后端API

### 1. 退票准备阶段API

**接口地址：** `POST /api/orders/refund/preparation`

**请求参数：**
```json
{
    "userId": 1,
    "orderId": 1,
    "ticketIds": [1, 2, 3]
}
```

**响应数据：**
```json
{
    "orderNumber": "订单号",
    "orderStatus": 1,
    "orderTime": "2025-01-10T10:00:00",
    "paymentTime": "2025-01-10T10:05:00",
    "paymentMethod": "支付宝",
    "totalAmount": 200.00,
    "ticketCount": 2,
    "trainNumber": "G101",
    "travelDate": "2025-01-15",
    "departureTime": "08:00",
    "arrivalTime": "10:30",
    "departureStation": "北京南站",
    "arrivalStation": "上海虹桥站",
    "refundRules": {
        "description": "退票规则说明",
        "refundRate": 0.8,
        "notice": "退票须知：退票将收取20%手续费，退款将在1-3个工作日内到账"
    },
    "refundableTickets": [
        {
            "ticketId": 1,
            "ticketNumber": "T20250110001",
            "passengerName": "张三",
            "idCardNumber": "110101199001011234",
            "passengerType": 1,
            "ticketType": 1,
            "carriageType": "二等座",
            "carriageNumber": "08",
            "seatNumber": "12A",
            "originalPrice": 100.00,
            "refundAmount": 80.00,
            "ticketStatus": 1,
            "canRefund": true,
            "refundReason": null
        }
    ]
}
```

### 2. 正式退票API

**接口地址：** `POST /api/ticket/refund`

**请求参数：**
```json
{
    "userId": 1,
    "orderId": 1,
    "ticketIds": [1, 2],
    "refundReason": "行程变更"
}
```

**响应数据：**
```json
{
    "status": "SUCCESS",
    "message": "退票成功"
}
```

## 前端页面流程

### 1. 订单详情页
- 用户点击"退票"按钮
- 传递参数：`orderId`、`ticketIds`、`userId`
- 跳转到退票页面：`/return-ticket?orderId=1&ticketIds=1,2,3&userId=1`

### 2. 退票页面（准备阶段）
- 页面加载时调用退票准备API
- 显示订单信息、车次信息、车票列表
- 用户可以选择要退票的车票
- 显示退票规则和须知

### 3. 退票页面（正式退票阶段）
- 用户点击"确认退票"按钮
- 调用正式退票API
- 退票成功后跳转回订单详情页
- 订单详情页会显示更新后的信息

## 测试步骤

### 1. 准备测试数据
确保数据库中有以下数据：
- 用户ID=1的用户
- 订单状态为已支付(1)或已完成(2)的订单
- 订单下有车票，车票状态为已支付(1)或已完成(2)

### 2. 测试退票准备阶段

1. **进入订单列表页面**
   - 访问：`http://localhost:3000/orders`
   - 确认能看到订单列表

2. **进入订单详情页面**
   - 点击任意订单进入详情页
   - 确认能看到订单信息和车票列表

3. **点击退票按钮**
   - 在订单详情页点击"退票"按钮
   - 确认跳转到退票页面，URL包含必要参数

4. **验证退票准备页面**
   - 确认页面显示订单信息
   - 确认页面显示车次信息
   - 确认页面显示车票列表
   - 确认车票可以被选中
   - 确认显示退票规则

### 3. 测试正式退票阶段

1. **选择要退票的车票**
   - 在退票页面选择要退票的车票
   - 确认选择状态正确显示

2. **点击确认退票**
   - 点击"确认退票"按钮
   - 确认按钮显示加载状态
   - 确认调用正式退票API

3. **验证退票结果**
   - 退票成功后显示成功消息
   - 自动跳转回订单详情页
   - 订单详情页显示更新后的信息（车票状态变为已退票）

### 4. 测试用例

#### 用例1：正常退票流程
- 订单状态：已支付
- 车票状态：已支付
- 预期结果：退票成功，车票状态更新为已退票

#### 用例2：部分车票退票
- 选择部分车票退票
- 预期结果：只有选中的车票被退票

#### 用例3：取消退票
- 点击取消按钮
- 预期结果：返回上一页面，不执行退票

#### 用例4：网络错误处理
- 模拟网络错误
- 预期结果：显示错误消息，不跳转页面

## 错误处理

### 1. 参数错误
- 缺少订单ID或车票ID：显示错误信息并跳转到订单列表
- 订单不存在：显示错误信息并跳转到订单列表

### 2. 权限错误
- 订单不属于当前用户：显示错误信息并跳转到订单列表

### 3. 网络错误
- API调用失败：显示错误信息，不跳转页面

### 4. 退票失败
- 后端退票失败：显示错误消息，保持在当前页面

## 注意事项

1. 退票准备阶段只是获取信息，不会修改任何数据
2. 正式退票阶段会实际修改车票状态和订单信息
3. 退票成功后，订单详情页会自动刷新显示最新状态
4. 退票操作不可逆，需要用户确认
5. 退票规则和费率由后端控制，前端只显示 