# 跨域配置完成说明

## 概述

已成功为所有相关页面和API配置了跨域支持，确保前端（localhost:3000）可以正常访问后端（localhost:8080）的API。

## 后端CORS配置

### 1. 全局CORS配置
**文件**: `src/main/java/com/example/techprototype/Config/WebConfig.java`

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(false)
                .maxAge(3600);
    }
}
```

### 2. 控制器级CORS配置

#### OrderController
- **文件**: `src/main/java/com/example/techprototype/Controller/OrderController.java`
- **配置**: `@CrossOrigin(origins = "*")`
- **API路径**: `/api/orders/*`

#### TicketController
- **文件**: `src/main/java/com/example/techprototype/Controller/TicketController.java`
- **配置**: `@CrossOrigin(origins = "*")`
- **API路径**: `/api/ticket/*`

#### PrepareOrderController
- **文件**: `src/main/java/com/example/techprototype/Controller/PrepareOrderController.java`
- **配置**: `@CrossOrigin(origins = "*")`
- **API路径**: `/api/prepare-order/*`

#### PaymentController
- **文件**: `src/main/java/com/example/techprototype/Controller/PaymentController.java`
- **配置**: `@CrossOrigin(origins = "*")`
- **API路径**: `/api/payment/*`

## 前端页面配置

### 1. 我的订单页面 (Orders)
- **文件**: `mini-12306/src/pages/Orders/index.jsx`
- **测试用户ID**: `userId = 1`
- **主要API**: 
  - `orderAPI.getMyOrders(userId)`
  - `orderAPI.getMyOrdersByConditions(userId, ...)`
  - `orderAPI.cancelOrder(orderId, userId)`

### 2. 订单详情页面 (OrderDetail)
- **文件**: `mini-12306/src/pages/OrderDetail/index.jsx`
- **测试用户ID**: `userId = 1`
- **主要API**: 
  - `orderAPI.getOrderDetail(orderId, userId)`
  - `orderAPI.cancelOrder(orderNumber, userId)`

### 3. 本人车票页面 (MyTickets)
- **文件**: `mini-12306/src/pages/MyTickets/index.jsx`
- **测试用户ID**: `userId = 1`
- **主要API**: 
  - `ticketAPI.getMyTickets(userId)`
  - `ticketAPI.getMyTicketsByStatus(userId, status)`

### 4. 车票详情页面 (TicketDetail)
- **文件**: `mini-12306/src/pages/TicketDetail/index.jsx`
- **测试用户ID**: `userId = 1`
- **主要API**: 
  - `ticketAPI.getTicketDetail(ticketId, userId)`

### 5. 退票页面 (ReturnTicket)
- **文件**: `mini-12306/src/pages/ReturnTicket/index.jsx`
- **测试用户ID**: `userId = 1` (从URL参数获取，默认值为1)
- **主要API**: 
  - `orderAPI.getRefundPreparation(userId, orderId, ticketIds)` (准备阶段)
  - `ticketAPI.refundTickets(userId, orderId, ticketIds)` (正式退票)

### 6. 提交订单页面 (SubmitOrder)
- **文件**: `mini-12306/src/pages/SubmitOrder/index.jsx`
- **测试用户ID**: `userId = 1`
- **主要API**: 
  - `orderAPI.prepareOrder(userId, inventoryIds)`

## API服务配置

### 文件: `mini-12306/src/services/api.js`

#### 订单相关API
```javascript
export const orderAPI = {
    getMyOrders: (userId) => request(`/orders/my?userId=${userId}`),
    getMyOrdersByConditions: (userId, ...) => request(`/orders/my/filter?${params}`),
    getOrderDetail: (orderId, userId) => request(`/orders/detail?orderId=${orderId}&userId=${userId}`),
    cancelOrder: (orderId, userId) => request('/orders/cancel', { method: 'POST', body: JSON.stringify({ orderId, userId }) }),
    getRefundPreparation: (userId, orderId, ticketIds) => request('/orders/refund/preparation', { method: 'POST', body: JSON.stringify({ userId, orderId, ticketIds }) }),
    prepareOrder: (userId, inventoryIds) => request('/prepare-order/prepare', { method: 'POST', body: JSON.stringify({ userId, inventoryIds }) }),
};
```

#### 车票相关API
```javascript
export const ticketAPI = {
    getMyTickets: (userId) => request(`/ticket/my-tickets?userId=${userId}`),
    getMyTicketsByStatus: (userId, ticketStatus) => request(`/ticket/my-tickets/status?userId=${userId}&ticketStatus=${ticketStatus}`),
    getTicketDetail: (ticketId, userId) => request(`/ticket/detail?ticketId=${ticketId}&userId=${userId}`),
    refundTickets: (userId, orderId, ticketIds) => request('/ticket/refund', { method: 'POST', body: JSON.stringify({ userId, orderId, ticketIds, refundReason: "行程变更" }) }),
};
```

## 测试要点

### 1. 我的订单页面测试
- [ ] 访问 `/orders` 页面
- [ ] 验证订单列表正常加载
- [ ] 测试搜索功能（订单号、车次号、状态、日期范围）
- [ ] 测试订单操作（支付、取消、查看详情）

### 2. 订单详情页面测试
- [ ] 从订单列表点击进入订单详情
- [ ] 验证订单信息完整显示
- [ ] 测试订单操作（支付、取消、退票、改签）

### 3. 本人车票页面测试
- [ ] 访问 `/my-tickets` 页面
- [ ] 验证车票列表正常加载
- [ ] 测试状态筛选功能
- [ ] 测试车票详情查看

### 4. 车票详情页面测试
- [ ] 从车票列表点击进入车票详情
- [ ] 验证车票信息完整显示
- [ ] 测试返回功能

### 5. 退票页面测试
- [ ] 从订单详情点击退票进入退票页面
- [ ] 验证退票准备信息正常加载
- [ ] 测试车票选择功能
- [ ] 测试确认退票功能

### 6. 提交订单页面测试
- [ ] 从车次列表进入提交订单页面
- [ ] 验证订单准备信息正常加载
- [ ] 测试乘客选择和票种选择
- [ ] 测试提交订单功能

## 技术要点

### 1. CORS配置策略
- **全局配置**: 使用`WebConfig`配置全局CORS规则
- **控制器配置**: 为每个控制器添加`@CrossOrigin`注解作为双重保障
- **配置参数**: 
  - `allowedOriginPatterns("*")`: 允许所有来源
  - `allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")`: 允许的HTTP方法
  - `allowedHeaders("*")`: 允许所有请求头
  - `allowCredentials(false)`: 不发送凭证（避免与通配符冲突）

### 2. 前端API调用
- **统一配置**: 使用`API_BASE_URL`统一管理API基础地址
- **错误处理**: 统一的错误处理和用户提示
- **测试用户**: 所有页面使用`userId = 1`作为测试用户

### 3. 数据流
- **请求流程**: 前端 → API服务 → 后端控制器 → 业务服务 → 数据库
- **响应流程**: 数据库 → 业务服务 → 后端控制器 → API服务 → 前端
- **错误处理**: 各层都有完整的错误处理和日志记录

## 总结

✅ **跨域配置完成**: 所有相关页面和API都已正确配置CORS支持

✅ **测试用户配置**: 所有页面都使用`userId = 1`作为测试用户

✅ **API服务完整**: 前端API服务覆盖了所有必要的后端接口

✅ **错误处理完善**: 前后端都有完整的错误处理和用户提示

现在所有页面都应该能够正常访问后端API，不再出现跨域错误。 