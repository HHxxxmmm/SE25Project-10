# 提交订单功能测试计划

## 功能概述

提交订单功能将提交订单页面的"提交订单"按钮与后端的确认购票API绑定，实现真正的购票流程。

## 技术实现

### 1. 前端修改
- **文件**: `mini-12306/src/services/api.js`
  - 添加了 `ticketAPI.bookTickets()` 购票API

- **文件**: `mini-12306/src/pages/SubmitOrder/index.jsx`
  - 导入了 `ticketAPI`
  - 修改了 `handleSubmitOrder` 函数，实现真正的购票API调用
  - 构建购票请求包含：车次信息、乘客信息、票种、席别等

### 2. 后端修改
- **文件**: `src/main/java/com/example/techprototype/DTO/PrepareOrderResponse.java`
  - 在 `TrainInfo` 类中添加了 `trainId`、`departureStopId`、`arrivalStopId` 字段
  - 在 `CarriageInfo` 类中添加了 `carriageTypeId` 字段

- **文件**: `src/main/java/com/example/techprototype/Service/Impl/PrepareOrderServiceImpl.java`
  - 修改了车次信息构建逻辑，返回完整的车次信息
  - 修改了席别信息构建逻辑，返回席别类型ID

## 购票请求结构

```json
{
  "userId": 1,
  "trainId": 1,
  "departureStopId": 1,
  "arrivalStopId": 2,
  "travelDate": "2025-07-10",
  "carriageTypeId": 1,
  "passengers": [
    {
      "passengerId": 1,
      "ticketType": 1
    },
    {
      "passengerId": 2,
      "ticketType": 3
    }
  ]
}
```

## 测试步骤

### 1. 准备阶段
1. 启动后端服务（确保在8080端口）
2. 启动前端服务（确保在3000端口）
3. 确保数据库中有测试数据

### 2. 进入提交订单页面
1. 访问 `http://localhost:3000`
2. 导航到车次列表页面
3. 点击某个车次的"购票"按钮
4. 应该跳转到提交订单页面

### 3. 验证页面数据加载
1. 检查页面是否正确显示车次信息
2. 检查是否显示席别信息和价格
3. 检查是否显示用户关联的乘客列表
4. 检查乘客类型限制是否正确（学生只能买学生票或成人票等）

### 4. 选择乘客和票种
1. 选择1-3位乘客
2. 为每位乘客选择合适的票种
3. 验证票种选择是否符合乘客类型限制

### 5. 提交订单测试
1. 点击"提交订单"按钮
2. 观察控制台日志，确认：
   - 购票请求数据正确
   - 包含正确的车次信息
   - 包含正确的乘客ID和票种
   - 包含正确的席别类型ID

### 6. 验证API响应
1. 检查后端日志，确认：
   - 接收到购票请求
   - 请求参数正确
   - 返回正确的订单号

### 7. 验证页面跳转
1. 确认购票成功后跳转到支付页面
2. 确认URL参数包含订单号：`/payment?orderNumber=xxx`
3. 确认本地存储中保存了订单号

## 预期结果

### 成功场景
1. 购票请求发送成功
2. 后端返回成功响应，包含订单号
3. 前端显示"购票成功"消息
4. 页面跳转到支付页面
5. 支付页面能正确显示订单信息

### 失败场景
1. 如果没有选择乘客，显示"请至少选择一位乘车人"
2. 如果没有可用席别，显示"没有可用的席别"
3. 如果乘客信息不完整，显示"部分乘客信息不完整"
4. 如果API调用失败，显示"购票失败，请稍后重试"

## 调试信息

### 前端控制台日志
- 购票请求数据
- API响应数据
- 错误信息

### 后端控制台日志
- 接收到的购票请求
- 订单创建过程
- 错误信息

## 注意事项

1. **测试用户ID**: 使用 `userId = 1` 进行测试
2. **库存ID**: 使用 `inventoryIds = [1, 11, 21]` 进行测试
3. **乘客ID**: 确保选择的乘客在数据库中存在
4. **票种限制**: 验证不同乘客类型的票种选择限制
5. **席别选择**: 当前简化处理，使用第一个有票的席别

## 相关文件

### 前端文件
- `mini-12306/src/services/api.js` - API服务
- `mini-12306/src/pages/SubmitOrder/index.jsx` - 提交订单页面

### 后端文件
- `src/main/java/com/example/techprototype/Controller/TicketController.java` - 购票控制器
- `src/main/java/com/example/techprototype/Service/Impl/TicketServiceImpl.java` - 购票服务
- `src/main/java/com/example/techprototype/DTO/BookingRequest.java` - 购票请求DTO
- `src/main/java/com/example/techprototype/DTO/PrepareOrderResponse.java` - 准备订单响应DTO
- `src/main/java/com/example/techprototype/Service/Impl/PrepareOrderServiceImpl.java` - 准备订单服务

### 支付页面
- `mini-12306/src/pages/Payment/index.jsx` - 支付页面 