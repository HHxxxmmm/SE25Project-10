# 数据库结构变更说明

## 概述
根据新的业务需求，对数据库结构进行了重要变更，主要包括用户乘客关联机制优化和学生票管理功能增强。

## 主要变更

### 1. passengers表变更
**新增字段**：
- `student_type_left` (tinyint, default 0)
  - 学生剩余次数，仅当passenger_type=3(学生)时设为4，其他设为0
  - 用于管理学生票的剩余购买次数

**变更说明**：
- 学生类型乘客初始拥有4次学生票购买机会
- 其他类型乘客（成人、儿童、残疾军人）该字段为0
- 每次购买学生票时需检查并扣减剩余次数

### 2. users表变更
**移除字段**：
- `id_card_number` - 身份证号字段

**新增字段**：
- `related_passenger` (int, default 0)
  - 关联乘客数量，记录该用户当前关联的乘车人数量
- `passenger_id` (bigint, nullable)
  - 直接关联的乘客ID，外键关联到passengers表

**新增约束**：
- `fk_user_passenger` - 外键约束，关联passengers表

**变更说明**：
- 用户现在直接关联到具体的乘客记录
- 通过related_passenger字段快速获取用户关联的乘客数量
- 简化了用户与乘客的关联关系

### 3. seats表变更
**字段类型变更**：
- `isAvailable` → `is_available`
- 类型从 `tinyint default 1` 改为 `bit`

**变更说明**：
- 字段名规范化，使用下划线命名
- 使用bit类型更准确地表示布尔值
- 保持原有的座位可用性管理逻辑

### 4. trains表变更
**字段精度变更**：
- `departure_time` 和 `arrival_time` 从 `time` 改为 `time(6)`
- 提高时间精度，支持微秒级时间记录

## 实体类更新

### Passenger实体类
```java
@Column(name = "student_type_left")
private Integer studentTypeLeft = 0; // 学生剩余次数
```

### User实体类
```java
@Column(name = "related_passenger", nullable = false)
private Integer relatedPassenger = 0; // 关联乘客数量

@Column(name = "passenger_id")
private Long passengerId; // 关联的乘客ID

@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "passenger_id", insertable = false, updatable = false)
private Passenger passenger;
```

## 业务逻辑影响

### 1. 学生票管理
- 购票时需要检查学生乘客的剩余次数
- 购买学生票时扣减剩余次数
- 退票时恢复学生票剩余次数

### 2. 用户乘客关联
- 用户注册时可以直接关联到乘客记录
- 通过related_passenger字段快速统计关联乘客数量
- 简化了用户乘客关系的管理

### 3. 座位管理
- 座位状态管理逻辑保持不变
- 字段名变更不影响现有业务逻辑

## 迁移注意事项

1. **数据迁移**：
   - 需要为现有学生乘客设置初始的student_type_left值
   - 需要为现有用户设置related_passenger和passenger_id值

2. **代码适配**：
   - 更新所有涉及用户身份证号的代码
   - 添加学生票剩余次数的检查逻辑
   - 更新座位相关的查询语句

3. **测试验证**：
   - 验证学生票购买和退票逻辑
   - 验证用户乘客关联功能
   - 验证座位管理功能

## 兼容性说明

- 新字段都有默认值，不会影响现有数据
- 外键约束确保数据一致性
- 字段类型变更保持向后兼容 