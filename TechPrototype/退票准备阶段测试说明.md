# 退票准备阶段功能测试说明

## 功能概述

退票准备阶段是退票流程的第一步，用户从订单详情页进入退票页面时，系统会获取订单信息、车票信息和退票规则，供用户确认退票。

## 后端API

### 1. 退票准备API

**接口地址：** `POST /api/orders/refund/preparation`

**请求参数：**
```json
{
    "userId": 1,
    "orderId": "订单ID",
    "ticketIds": [1, 2, 3]
}
```

**响应数据：**
```json
{
    "orderNumber": "订单号",
    "orderStatus": 1,
    "orderTime": "2025-01-10T10:00:00",
    "paymentTime": "2025-01-10T10:05:00",
    "paymentMethod": "支付宝",
    "totalAmount": 200.00,
    "ticketCount": 2,
    "trainNumber": "G101",
    "travelDate": "2025-01-15",
    "departureTime": "08:00",
    "arrivalTime": "10:30",
    "departureStation": "北京南站",
    "arrivalStation": "上海虹桥站",
    "refundRules": {
        "description": "退票规则说明",
        "refundRate": 0.8,
        "notice": "退票须知：退票将收取20%手续费，退款将在1-3个工作日内到账"
    },
    "refundableTickets": [
        {
            "ticketId": 1,
            "ticketNumber": "T20250110001",
            "passengerName": "张三",
            "idCardNumber": "110101199001011234",
            "passengerType": 1,
            "ticketType": 1,
            "carriageType": "二等座",
            "carriageNumber": "08",
            "seatNumber": "12A",
            "originalPrice": 100.00,
            "refundAmount": 80.00,
            "ticketStatus": 1,
            "canRefund": true,
            "refundReason": null
        }
    ]
}
```

## 前端页面

### 1. 订单详情页修改

- 退票按钮现在会传递订单ID和车票ID列表到退票页面
- URL格式：`/return-ticket?orderId=订单号&ticketIds=1,2,3&userId=1`

### 2. 退票页面功能

- 从URL参数获取订单ID、车票ID列表和用户ID
- 调用后端退票准备API获取详细信息
- 显示订单信息、车次信息、车票列表
- 支持选择要退票的车票（只能选择可退票的车票）
- 显示退票规则和预计退款金额
- 显示退票须知

## 测试步骤

### 1. 准备测试数据

确保数据库中有以下数据：
- 用户ID=1的用户
- 订单状态为已支付(1)或已完成(2)的订单
- 订单下有车票，车票状态为已支付(1)或已完成(2)

### 2. 测试流程

1. **进入订单列表页面**
   - 访问：`http://localhost:3000/orders`
   - 确认能看到订单列表

2. **进入订单详情页面**
   - 点击任意订单进入详情页
   - 确认能看到订单信息和车票列表

3. **点击退票按钮**
   - 在订单详情页点击"退票"按钮
   - 确认跳转到退票页面，URL包含必要参数

4. **验证退票页面**
   - 确认页面显示订单信息
   - 确认页面显示车次信息
   - 确认页面显示车票列表
   - 确认可退票的车票可以被选中
   - 确认不可退票的车票显示原因
   - 确认显示退票规则和预计退款金额

### 3. 测试用例

#### 用例1：正常退票流程
- 订单状态：已支付
- 车票状态：已支付
- 发车时间：24小时以后
- 预期结果：车票可退票，显示80%退款金额

#### 用例2：不可退票情况
- 订单状态：已取消
- 预期结果：显示"订单状态不允许退票"

#### 用例3：发车前24小时内
- 发车时间：12小时后
- 预期结果：显示"发车前24小时内不可退票"

#### 用例4：部分车票可退
- 部分车票已退票
- 预期结果：已退票的车票显示"不可退票"，其他车票正常显示

## 错误处理

### 1. 参数错误
- 缺少订单ID或车票ID：显示错误信息并跳转到订单列表
- 订单不存在：显示错误信息并跳转到订单列表

### 2. 权限错误
- 订单不属于当前用户：显示错误信息并跳转到订单列表

### 3. 网络错误
- API调用失败：显示错误信息并跳转到订单列表

## 注意事项

1. 退票准备阶段只是获取信息，不会实际执行退票操作
2. 退票规则和费率是硬编码的，实际项目中应该从配置或数据库获取
3. 发车前24小时的判断逻辑可能需要根据实际业务需求调整
4. 车票状态和订单状态的判断逻辑需要与业务规则保持一致 