# 提交订单功能完整测试计划

## 功能概述

提交订单功能将提交订单页面的"提交订单"按钮与后端的确认购票API绑定，实现真正的购票流程。采用同步创建订单 + 异步处理车票的方案。

## 技术实现

### 1. 后端修改

#### 购票API修改
- **文件**: `src/main/java/com/example/techprototype/Service/Impl/TicketServiceImpl.java`
  - 修改 `bookTickets` 方法，立即创建订单并返回订单ID
  - 添加 `calculateTicketPrice` 方法计算票价
  - 异步处理车票创建和座位分配

#### 订单消息修改
- **文件**: `src/main/java/com/example/techprototype/DTO/OrderMessage.java`
  - 添加 `orderId` 字段

#### 订单处理器修改
- **文件**: `src/main/java/com/example/techprototype/Component/OrderProcessor.java`
  - 修改为查找已存在的订单而不是创建新订单
  - 异步创建车票和分配座位

#### 准备订单响应修改
- **文件**: `src/main/java/com/example/techprototype/DTO/PrepareOrderResponse.java`
  - 在 `TrainInfo` 类中添加 `trainId`、`departureStopId`、`arrivalStopId` 字段
  - 在 `CarriageInfo` 类中添加 `carriageTypeId` 字段

- **文件**: `src/main/java/com/example/techprototype/Service/Impl/PrepareOrderServiceImpl.java`
  - 修改车次信息构建逻辑，返回完整的车次信息
  - 修改席别信息构建逻辑，返回席别类型ID

### 2. 前端修改

#### API服务修改
- **文件**: `mini-12306/src/services/api.js`
  - 添加了 `ticketAPI.bookTickets()` 购票API

#### 提交订单页面修改
- **文件**: `mini-12306/src/pages/SubmitOrder/index.jsx`
  - 导入了 `ticketAPI`
  - 修改了 `handleSubmitOrder` 函数，实现真正的购票API调用
  - 构建购票请求包含：车次信息、乘客信息、票种、席别等
  - 使用订单ID跳转到支付页面

## 购票流程

### 1. 同步阶段（购票API）
1. 验证乘客关系
2. 检查时间冲突
3. 预减Redis库存
4. **立即创建订单**（新增）
5. 计算总金额
6. 发送订单消息到RabbitMQ
7. **返回订单ID和订单号**（修改）

### 2. 异步阶段（RabbitMQ处理）
1. 查找已存在的订单
2. 创建车票记录
3. 分配座位
4. 保存车票信息

## 购票请求结构

```json
{
  "userId": 1,
  "trainId": 1,
  "departureStopId": 1,
  "arrivalStopId": 2,
  "travelDate": "2025-07-10",
  "carriageTypeId": 1,
  "passengers": [
    {
      "passengerId": 1,
      "ticketType": 1
    },
    {
      "passengerId": 2,
      "ticketType": 3
    }
  ]
}
```

## 购票响应结构

```json
{
  "status": "SUCCESS",
  "message": "购票成功",
  "orderNumber": "ORD2025071012345678",
  "orderId": 123,
  "totalAmount": 1106.00,
  "orderTime": "2025-07-10T16:30:00"
}
```

## 测试步骤

### 1. 准备阶段
1. 启动后端服务（确保在8080端口）
2. 启动前端服务（确保在3000端口）
3. 确保数据库中有测试数据

### 2. 进入提交订单页面
1. 访问 `http://localhost:3000`
2. 导航到车次列表页面
3. 点击某个车次的"购票"按钮
4. 应该跳转到提交订单页面

### 3. 验证页面数据加载
1. 检查页面是否正确显示车次信息
2. 检查是否显示席别信息和价格
3. 检查是否显示用户关联的乘客列表
4. 检查乘客类型限制是否正确（学生只能买学生票或成人票等）

### 4. 选择乘客和票种
1. 选择1-3位乘客
2. 为每位乘客选择合适的票种
3. 验证票种选择是否符合乘客类型限制

### 5. 提交订单测试
1. 点击"提交订单"按钮
2. 观察控制台日志，确认：
   - 购票请求数据正确
   - 包含正确的车次信息
   - 包含正确的乘客ID和票种
   - 包含正确的席别类型ID

### 6. 验证API响应
1. 检查后端日志，确认：
   - 接收到购票请求
   - 请求参数正确
   - 订单立即创建成功
   - 返回正确的订单ID和订单号
   - RabbitMQ消息发送成功

### 7. 验证异步处理
1. 检查后端日志，确认：
   - OrderProcessor接收到消息
   - 找到已存在的订单
   - 车票创建成功
   - 座位分配成功

### 8. 验证页面跳转
1. 确认购票成功后跳转到支付页面
2. 确认URL参数包含订单ID：`/payment?orderId=123`
3. 确认本地存储中保存了订单ID和订单号

## 预期结果

### 成功场景
1. 购票请求发送成功
2. 后端立即创建订单并返回订单ID
3. 前端显示"购票成功"消息
4. 页面跳转到支付页面
5. 支付页面能正确显示订单信息
6. 异步处理车票创建和座位分配

### 失败场景
1. 如果没有选择乘客，显示"请至少选择一位乘车人"
2. 如果没有可用席别，显示"没有可用的席别"
3. 如果乘客信息不完整，显示"部分乘客信息不完整"
4. 如果API调用失败，显示"购票失败，请稍后重试"

## 调试信息

### 前端控制台日志
- 购票请求数据
- API响应数据（包含订单ID）
- 错误信息

### 后端控制台日志
- 接收到的购票请求
- 订单创建过程
- RabbitMQ消息发送
- 异步处理过程
- 错误信息

## 注意事项

1. **测试用户ID**: 使用 `userId = 1` 进行测试
2. **库存ID**: 使用 `inventoryIds = [1, 11, 21]` 进行测试
3. **乘客ID**: 确保选择的乘客在数据库中存在
4. **票种限制**: 验证不同乘客类型的票种选择限制
5. **席别选择**: 当前简化处理，使用第一个有票的席别
6. **异步处理**: 订单立即创建，车票异步处理

## 相关文件

### 后端文件
- `src/main/java/com/example/techprototype/Controller/TicketController.java` - 购票控制器
- `src/main/java/com/example/techprototype/Service/Impl/TicketServiceImpl.java` - 购票服务
- `src/main/java/com/example/techprototype/DTO/BookingRequest.java` - 购票请求DTO
- `src/main/java/com/example/techprototype/DTO/BookingResponse.java` - 购票响应DTO
- `src/main/java/com/example/techprototype/DTO/OrderMessage.java` - 订单消息DTO
- `src/main/java/com/example/techprototype/Component/OrderProcessor.java` - 订单处理器
- `src/main/java/com/example/techprototype/DTO/PrepareOrderResponse.java` - 准备订单响应DTO
- `src/main/java/com/example/techprototype/Service/Impl/PrepareOrderServiceImpl.java` - 准备订单服务

### 前端文件
- `mini-12306/src/services/api.js` - API服务
- `mini-12306/src/pages/SubmitOrder/index.jsx` - 提交订单页面
- `mini-12306/src/pages/Payment/index.jsx` - 支付页面

## 测试数据

### 测试参数
- `userId`: 1
- `inventoryIds`: [1, 11, 21]
- `trainId`: 1
- `departureStopId`: 1
- `arrivalStopId`: 2
- `travelDate`: "2025-07-10"
- `carriageTypeId`: 1

### 乘客信息
- 乘客ID: 1, 姓名: 张三, 类型: 成人
- 乘客ID: 2, 姓名: 李四, 类型: 学生
- 乘客ID: 3, 姓名: 王五, 类型: 儿童 