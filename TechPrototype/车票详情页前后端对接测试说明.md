# 车票详情页前后端对接测试说明

## 功能概述

车票详情页实现了从本人车票页面点击车票项跳转到详情页，显示完整的车票信息，包括：
- 车票基本信息（车票号、订单号等）
- 车次信息（车次号、出发到达站、时间等）
- 乘客信息（姓名、身份证、手机号等）
- 座位信息（车厢、座位、席别等）
- 价格和状态信息

## 前端实现

### 1. 页面路由
- 路径：`/ticket-detail?ticketId={ticketId}`
- 从URL参数获取ticketId

### 2. 数据获取
- 使用`ticketAPI.getTicketDetail(ticketId, userId)`获取车票详情
- 固定使用userId=1作为测试用户
- 包含完整的错误处理和加载状态

### 3. 数据展示
- 车票状态映射：待支付、未使用、已使用、已退票、已改签
- 票种映射：成人票、儿童票、学生票、残疾票、军人票
- 乘客类型映射：成人、儿童、学生、残疾军人
- 时间格式化：显示出发和到达时间

### 4. 界面组件
- 使用Ant Design的Card、Typography、Divider等组件
- 包含返回按钮、加载状态、错误提示
- 响应式设计，适配不同屏幕尺寸

## 后端实现

### 1. API接口
```java
@GetMapping("/detail")
public ResponseEntity<TicketDetailResponse> getTicketDetail(
    @RequestParam Long ticketId,
    @RequestParam Long userId)
```

### 2. 权限验证
- 验证车票乘客ID与用户乘客ID一致
- 验证车票所属订单的用户ID与当前用户ID一致
- 无权限时返回错误信息

### 3. 数据获取
- 根据ticketId查询车票信息
- 获取关联的订单、乘客、车站、车次信息
- 获取出发和到达时间
- 获取车厢类型名称

### 4. 响应数据结构
```java
public static class TicketDetailInfo {
    private Long ticketId;
    private String ticketNumber;
    private Long orderId;
    private String orderNumber;
    private Integer trainId;
    private String trainNumber;
    private Long departureStopId;
    private String departureStationName;
    private String departureCity;
    private Long arrivalStopId;
    private String arrivalStationName;
    private String arrivalCity;
    private LocalDate travelDate;
    private LocalTime departureTime;
    private LocalTime arrivalTime;
    private String carriageNumber;
    private String seatNumber;
    private BigDecimal price;
    private Byte ticketStatus;
    private String ticketStatusText;
    private Byte ticketType;
    private String ticketTypeText;
    private LocalDateTime createdTime;
    private LocalDateTime paymentTime;
    private String orderStatusText;
    private String passengerName;
    private String passengerIdCard;
    private String passengerPhone;
    private Byte passengerType;
    private String passengerTypeText;
    private String digitalSignature;
    private Integer runningDays;
    private Integer carriageTypeId;
    private String carriageTypeName;
}
```

## 测试步骤

### 1. 准备测试数据
确保数据库中有以下数据：
- 用户信息（userId=1）
- 乘客信息（与用户关联）
- 车票信息（与乘客关联）
- 订单信息
- 车站和车次信息

### 2. 启动服务
```bash
# 启动后端服务
mvn spring-boot:run

# 启动前端服务
cd mini-12306
npm start
```

### 3. 测试流程

#### 步骤1：访问本人车票页面
- 打开浏览器访问：`http://localhost:3000/my-tickets`
- 确认页面正常加载，显示车票列表

#### 步骤2：点击车票项
- 在车票列表中点击任意一个车票项
- 确认URL变为：`http://localhost:3000/ticket-detail?ticketId={实际ID}`

#### 步骤3：验证车票详情页
- 确认页面显示加载状态
- 确认车票详情信息正确显示：
  - 车票状态和颜色
  - 车次信息和时间
  - 乘客信息
  - 座位和价格信息
  - 订单相关信息

#### 步骤4：测试错误情况
- 使用不存在的ticketId访问详情页
- 确认显示错误信息并跳转回本人车票页

### 4. 验证要点

#### 数据正确性
- [ ] 车票基本信息正确
- [ ] 车次和车站信息正确
- [ ] 时间信息正确（出发和到达时间）
- [ ] 乘客信息正确
- [ ] 价格和状态信息正确

#### 权限验证
- [ ] 使用正确用户ID可以访问
- [ ] 使用错误用户ID无法访问
- [ ] 不存在的车票ID返回错误

#### 界面交互
- [ ] 加载状态正常显示
- [ ] 错误信息正确提示
- [ ] 返回按钮功能正常
- [ ] 响应式布局正常

#### 数据映射
- [ ] 车票状态正确映射
- [ ] 票种正确映射
- [ ] 乘客类型正确映射
- [ ] 时间格式正确显示

## 常见问题

### 1. 车票详情页无法加载
- 检查后端服务是否正常启动
- 检查数据库连接是否正常
- 检查ticketId参数是否正确传递

### 2. 权限验证失败
- 确认用户ID为1
- 确认用户关联了正确的乘客信息
- 确认车票属于该乘客或用户

### 3. 时间显示异常
- 检查后端返回的时间格式
- 检查前端时间格式化函数
- 确认数据库中的时间数据正确

### 4. 状态映射错误
- 检查前端状态映射常量
- 确认后端返回的状态值
- 验证映射逻辑的正确性

## 技术要点

### 1. 前后端数据一致性
- 使用统一的字段命名
- 确保数据类型匹配
- 处理空值和异常情况

### 2. 错误处理
- 前端：网络错误、数据错误、权限错误
- 后端：数据库错误、业务逻辑错误、参数错误

### 3. 性能优化
- 前端：合理使用useEffect依赖
- 后端：优化数据库查询，避免N+1问题

### 4. 用户体验
- 加载状态提示
- 错误信息友好显示
- 返回导航功能

## 总结

车票详情页成功实现了前后端对接，提供了完整的车票信息展示功能。通过合理的权限验证、错误处理和用户界面设计，确保了功能的稳定性和用户体验的良好性。 