# 支付功能测试计划

## 功能概述
支付页面支持三种支付方式（支付宝、微信支付、银行卡），但实际使用后端在线支付API进行模拟支付。

## 测试环境
- 前端：http://localhost:3000
- 后端：http://localhost:8080
- 测试用户ID：1

## 测试用例

### 1. 从提交订单页面进入支付页面

#### 测试步骤：
1. 访问提交订单页面：http://localhost:3000/submit-order
2. 选择3个乘客（倪丽萍、冉志伟、单福贵）
3. 为每个乘客选择不同的席别：
   - 倪丽萍：商务座
   - 冉志伟：一等座
   - 单福贵：二等座（儿童票）
4. 填写乘客信息（身份证号、票种等）
5. 点击"提交订单"按钮
6. 等待订单创建完成，自动跳转到支付页面

#### 预期结果：
- 订单创建成功，生成订单号
- 自动跳转到支付页面：http://localhost:3000/payment?orderId=1
- 支付页面显示正确的订单信息：
  - 车次信息：G-704
  - 出发站：中卫市
  - 到达站：新乡市
  - 发车时间：2025-07-01
  - 乘客信息正确显示
  - 总金额正确（商务座560元 + 一等座302.5元 + 二等座儿童票84元 = 946.5元）

### 2. 从订单详情页面进入支付页面

#### 测试步骤：
1. 访问订单列表页面：http://localhost:3000/orders
2. 找到状态为"待支付"的订单
3. 点击"查看详情"
4. 在订单详情页面点击"去支付"按钮

#### 预期结果：
- 正确跳转到支付页面
- URL参数正确：orderId=1
- 订单信息显示正确

### 3. 支付功能测试

#### 测试步骤：
1. 在支付页面选择支付方式（支付宝/微信支付/银行卡）
2. 点击"立即支付"按钮
3. 观察支付结果

#### 预期结果：
- 支付成功，显示"支付成功"消息
- 订单状态更新为"已支付"
- 车票状态更新为"未使用"
- 跳转到订单详情页面
- 后端日志显示支付处理过程

### 4. 支付超时测试

#### 测试步骤：
1. 进入支付页面
2. 等待15分钟（或修改代码缩短超时时间）
3. 观察超时处理

#### 预期结果：
- 显示"支付超时，订单已取消"消息
- 自动跳转到订单列表页面
- 订单状态更新为"已取消"

### 5. 取消支付测试

#### 测试步骤：
1. 在支付页面点击"取消支付"按钮
2. 观察页面跳转

#### 预期结果：
- 跳转到订单列表页面
- 订单状态保持"待支付"

### 6. 错误处理测试

#### 测试场景：
1. 订单不存在
2. 订单状态不正确
3. 网络错误

#### 测试步骤：
1. 直接访问：http://localhost:3000/payment?orderId=999
2. 观察错误处理

#### 预期结果：
- 显示相应的错误消息
- 跳转到订单列表页面

## 后端API验证

### 1. 订单详情API
- URL：GET /api/orders/detail?userId=1&orderId=1
- 预期响应：包含订单基本信息和车票列表

### 2. 支付API
- URL：POST /api/payment/pay
- 参数：orderId=1&userId=1
- 预期响应：支付成功，订单状态更新

## 数据验证

### 1. 数据库验证
- 检查orders表的order_status字段是否更新为1（已支付）
- 检查tickets表的ticket_status字段是否更新为0（未使用）
- 检查payment_time字段是否正确设置

### 2. Redis验证
- 检查订单缓存是否正确更新
- 检查车票缓存是否正确更新

## 注意事项

1. **订单ID vs 订单号**：所有API调用都使用订单ID（orderId），而不是订单号（orderNumber）

2. **用户ID**：测试使用固定的用户ID=1

3. **CORS配置**：确保后端已正确配置CORS，支持前端跨域请求

4. **支付方式**：虽然前端显示三种支付方式，但实际都调用同一个后端支付API

5. **异步处理**：订单创建是异步的，需要等待RabbitMQ处理完成

## 测试数据

### 测试订单信息
- 订单ID：1
- 车次：G-704
- 出发站：中卫市
- 到达站：新乡市
- 发车时间：2025-07-01
- 乘客：倪丽萍、冉志伟、单福贵
- 席别：商务座、一等座、二等座
- 总金额：946.5元

### 测试用户
- 用户ID：1
- 乘客信息：已预置在数据库中 