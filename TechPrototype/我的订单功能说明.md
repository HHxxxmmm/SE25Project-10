# 我的订单功能详细说明

## 功能概述

我的订单功能为用户提供了完整的订单管理体验，包括：
1. 查看所有订单列表
2. 获取订单的详细车次信息
3. 支持多种过滤条件
4. 提供丰富的订单信息展示

## 核心特性

### 1. 订单信息展示
- **订单基本信息**: 订单号、下单时间、总金额、订单状态、支付方式、支付时间
- **车次信息**: 从订单中任意一张车票获取代表车次信息
- **车票统计**: 显示订单包含的车票数量

### 2. 车次信息获取
每个订单会返回一张代表车票的车次信息，包括：
- 车次号（如：G1、D2等）
- 出发日期
- 出发站名称和所在城市
- 到达站名称和所在城市
- 出发时间和到达时间

### 3. 过滤功能
支持多种过滤条件：
- **订单号过滤**: 支持模糊匹配
- **车票出发时间范围过滤**: 支持按车票的出发日期范围过滤
- **订单状态过滤**: 支持按订单状态精确匹配
- **车次号过滤**: 支持模糊匹配

## 技术实现

### 1. 数据查询策略
- 优先使用数据库索引查询，提高查询效率
- 支持分页查询，避免大量数据影响性能
- 使用JPA的@Query注解优化复杂查询

### 2. 车次信息获取逻辑
```java
// 获取订单中的任意一张车票作为代表
List<Ticket> tickets = ticketRepository.findByOrderId(order.getOrderId());
if (tickets.isEmpty()) {
    continue; // 跳过没有车票的订单
}

// 使用第一张车票作为代表
Ticket representativeTicket = tickets.get(0);
```

### 3. 关联数据查询
- 通过车票ID查询车次信息
- 通过停靠站ID查询车站信息
- 通过车站ID查询城市信息
- 通过停靠站ID查询时间信息

## API接口详情

### 1. 获取我的订单
**接口**: `GET /api/orders/my`

**请求参数**:
- `userId` (Long, 必需): 用户ID

**响应示例**:
```json
{
  "status": "SUCCESS",
  "message": "获取成功",
  "orders": [
    {
      "orderId": 1,
      "orderNumber": "202507070001",
      "orderTime": "2025-07-07T10:30:00",
      "totalAmount": 299.00,
      "orderStatus": 1,
      "orderStatusText": "已支付",
      "paymentMethod": "支付宝",
      "paymentTime": "2025-07-07T10:35:00",
      "trainId": 1,
      "trainNumber": "G1",
      "departureDate": "2025-07-10",
      "departureTime": "08:00:00",
      "arrivalTime": "10:30:00",
      "departureStationName": "北京南站",
      "departureCity": "北京",
      "arrivalStationName": "上海虹桥站",
      "arrivalCity": "上海",
      "ticketCount": 2
    }
  ],
  "timestamp": "2025-07-07T16:30:00"
}
```

### 2. 根据条件获取我的订单
**接口**: `GET /api/orders/my/filter`

**请求参数**:
- `userId` (Long, 必需): 用户ID
- `orderNumber` (String, 可选): 订单号（模糊匹配）
- `startDate` (LocalDate, 可选): 开始日期（YYYY-MM-DD）
- `endDate` (LocalDate, 可选): 结束日期（YYYY-MM-DD）
- `orderStatus` (Byte, 可选): 订单状态
- `trainNumber` (String, 可选): 车次号（模糊匹配）

**过滤逻辑**:
1. 如果指定了订单号，按订单号模糊匹配
2. 如果指定了订单状态，按订单状态精确匹配
3. 如果指定了时间范围，按车票出发时间范围过滤（查询该日期范围内有车票出发的订单）
4. 如果指定了车次号，在结果中按车次号模糊匹配

## 数据库设计

### 相关表结构
- `orders`: 订单表
- `tickets`: 车票表
- `trains`: 车次表
- `train_stops`: 车次停靠站表
- `stations`: 车站表

### 查询优化
- 在`orders`表的`user_id`字段上建立索引
- 在`orders`表的`order_time`字段上建立索引
- 在`tickets`表的`order_id`字段上建立索引

## 前端集成指南

### 1. 页面布局建议
```
+------------------------+
|  我的订单              |
+------------------------+
| 筛选条件:              |
| [订单号] [开始日期] [结束日期] |
| [订单状态] [车次号] [查询] |
+------------------------+
| 订单列表:              |
| +------------------+   |
| | 订单号: 202507070001 |   |
| | 车次: G1 北京→上海   |   |
| | 时间: 2025-07-10    |   |
| | 状态: 已支付        |   |
| | 金额: ¥299.00      |   |
| +------------------+   |
+------------------------+
```

### 2. 交互流程
1. 页面加载时调用基础接口获取所有订单
2. 用户输入筛选条件后点击查询
3. 根据筛选条件调用过滤接口
4. 展示过滤后的订单列表
5. 支持点击订单查看详情

### 3. 状态管理
- 维护当前筛选条件状态
- 缓存已查询的订单数据
- 支持分页加载更多订单

## 错误处理

### 1. 常见错误场景
- 用户ID不存在
- 数据库连接异常
- 关联数据查询失败

### 2. 错误响应格式
```json
{
  "status": "FAILURE",
  "message": "获取我的订单失败: 用户不存在",
  "orders": null,
  "timestamp": "2025-07-07T16:30:00"
}
```

## 性能优化建议

### 1. 数据库层面
- 使用合适的索引
- 避免N+1查询问题
- 考虑使用缓存

### 2. 应用层面
- 实现分页查询
- 使用异步加载
- 合理设置查询超时

### 3. 前端层面
- 实现虚拟滚动
- 使用防抖处理搜索
- 合理缓存数据

## 测试用例

### 1. 功能测试
- 测试获取所有订单
- 测试各种过滤条件
- 测试边界条件

### 2. 性能测试
- 测试大量订单的查询性能
- 测试并发访问性能
- 测试数据库连接池性能

### 3. 异常测试
- 测试无效用户ID
- 测试数据库异常
- 测试网络异常

## 扩展功能

### 1. 可能的扩展
- 支持订单导出
- 支持订单分享
- 支持订单提醒
- 支持订单评价

### 2. 技术改进
- 使用Redis缓存热门订单
- 实现订单搜索功能
- 支持订单排序功能
- 添加订单统计功能 