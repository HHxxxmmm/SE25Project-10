# 候补订单功能实现说明

## 功能概述

候补订单功能允许用户在余票不足时提交候补申请，系统会在有票时自动为用户购票。候补期限为发车前2小时。

## 数据库设计

### 1. 候补订单表 (waitlist_orders)
- `waitlist_id`: 主键
- `order_number`: 候补订单号 (WL+日期+序列)
- `user_id`: 用户ID
- `order_time`: 下单时间
- `total_amount`: 总金额
- `expire_time`: 过期时间 (发车前2小时)
- `order_status`: 订单状态 (0-待支付, 1-待兑现, 2-已兑现, 3-已取消)

### 2. 候补订单项表 (waitlist_items)
- `item_id`: 主键
- `waitlist_id`: 候补订单ID
- `passenger_id`: 乘客ID
- `train_id`: 车次ID
- `departure_stop_id`: 出发站ID
- `arrival_stop_id`: 到达站ID
- `travel_date`: 出行日期
- `carriage_type_id`: 车厢类型ID
- `ticket_type`: 票种
- `item_status`: 订单项状态 (0-待支付, 1-待兑现, 2-已兑现, 3-已取消)
- `created_time`: 创建时间

## 后端实现

### 1. 实体类
- `WaitlistOrder.java`: 候补订单实体
- `WaitlistItem.java`: 候补订单项实体

### 2. 枚举类
- `WaitlistOrderStatus.java`: 候补订单状态枚举
- `WaitlistItemStatus.java`: 候补订单项状态枚举

### 3. Repository接口
- `WaitlistOrderRepository.java`: 候补订单数据访问
- `WaitlistItemRepository.java`: 候补订单项数据访问

### 4. DTO类
- `WaitlistOrderResponse.java`: 候补订单列表响应
- `WaitlistOrderDetailResponse.java`: 候补订单详情响应

### 5. 服务层
- `WaitlistOrderService.java`: 候补订单服务接口
- `WaitlistOrderServiceImpl.java`: 候补订单服务实现

### 6. 控制器
- `WaitlistOrderController.java`: 候补订单API控制器

### 7. 定时任务
- `OrderTimeoutService.java`: 处理候补订单兑现的定时任务

## 前端实现

### 1. 提交订单页面修改
- 在 `SubmitOrder/index.jsx` 中添加候补订单弹窗
- 当购票失败且状态为 `INSUFFICIENT_STOCK` 时显示候补订单弹窗
- 用户可以选择提交候补订单或取消

### 2. 支付页面修改
- 在 `Payment/index.jsx` 中添加对候补订单的支持
- 通过URL参数 `isWaitlist=true` 和 `waitlistId` 识别候补订单
- 调用不同的API进行支付

### 3. 订单页面修改
- 在 `Orders/index.jsx` 中同时显示普通订单和候补订单
- 添加候补订单状态显示和操作按钮
- 支持候补订单的支付和取消操作

## API接口

### 1. 创建候补订单
```
POST /api/waitlist/create
Content-Type: application/json

{
  "userId": 1,
  "trainId": 1,
  "departureStopId": 1,
  "arrivalStopId": 2,
  "travelDate": "2024-01-01",
  "carriageTypeId": 1,
  "passengers": [
    {
      "passengerId": 1,
      "ticketType": 1,
      "carriageTypeId": 1
    }
  ]
}
```

### 2. 获取候补订单列表
```
GET /api/waitlist/my?userId=1
```

### 3. 获取候补订单详情
```
GET /api/waitlist/detail?userId=1&waitlistId=1
```

### 4. 支付候补订单
```
POST /api/waitlist/pay
Content-Type: application/x-www-form-urlencoded

waitlistId=1&userId=1
```

### 5. 取消候补订单
```
POST /api/waitlist/cancel
Content-Type: application/x-www-form-urlencoded

waitlistId=1&userId=1
```

## 业务流程

### 1. 候补订单创建流程
1. 用户在提交订单页面点击"提交订单"
2. 后端检查库存，如果不足返回 `INSUFFICIENT_STOCK` 状态
3. 前端显示候补订单弹窗
4. 用户选择"提交候补订单"
5. 前端调用候补订单创建API
6. 后端创建候补订单和候补订单项，状态为"待支付"
7. 跳转到支付页面

### 2. 候补订单支付流程
1. 用户在支付页面完成支付
2. 前端调用候补订单支付API
3. 后端更新候补订单状态为"待兑现"
4. 更新候补订单项状态为"待兑现"

### 3. 候补订单兑现流程
1. 定时任务每30秒检查一次候补订单兑现
2. 查询待兑现的候补订单
3. 检查是否有可用库存
4. 如果有库存，尝试兑现候补订单项
5. 更新候补订单项状态为"已兑现"
6. 检查候补订单是否全部兑现，如果是则更新候补订单状态为"已兑现"

### 4. 候补订单取消流程
1. 用户在订单页面点击"取消订单"
2. 前端调用候补订单取消API
3. 后端更新候补订单状态为"已取消"
4. 更新候补订单项状态为"已取消"

## 状态说明

### 候补订单状态
- `0-待支付`: 候补订单已创建，等待用户支付
- `1-待兑现`: 候补订单已支付，等待有票时兑现
- `2-已兑现`: 候补订单已全部兑现
- `3-已取消`: 候补订单已取消

### 候补订单项状态
- `0-待支付`: 候补订单项已创建，等待用户支付
- `1-待兑现`: 候补订单项已支付，等待有票时兑现
- `2-已兑现`: 候补订单项已兑现
- `3-已取消`: 候补订单项已取消

## 注意事项

1. 候补订单号格式为 "WL+日期+序列"，例如 "WL20240101000001"
2. 候补期限为发车前2小时
3. 候补订单按创建时间优先兑现
4. 候补订单兑现时会自动创建正式订单和车票
5. 候补订单支持部分兑现，部分兑现的候补订单状态为"部分成功"
6. 候补订单支持退款操作，退款后状态为"已取消" 
 