


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > OrderProcessor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.techprototype.Component</a>
</div>

<h1>Coverage Summary for Class: OrderProcessor (com.example.techprototype.Component)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">OrderProcessor</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    73.7%
  </span>
  <span class="absValue">
    (14/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86.9%
  </span>
  <span class="absValue">
    (86/99)
  </span>
</td>
</tr>
  <tr>
    <td class="name">OrderProcessor$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    73.7%
  </span>
  <span class="absValue">
    (14/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86.9%
  </span>
  <span class="absValue">
    (86/99)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.techprototype.Component;
&nbsp;
&nbsp;import com.example.techprototype.DTO.OrderMessage;
&nbsp;import com.example.techprototype.Entity.Order;
&nbsp;import com.example.techprototype.Entity.Ticket;
&nbsp;import com.example.techprototype.Entity.TicketInventory;
&nbsp;import com.example.techprototype.Enums.OrderStatus;
&nbsp;import com.example.techprototype.Enums.TicketStatus;
&nbsp;import com.example.techprototype.Repository.OrderRepository;
&nbsp;import com.example.techprototype.Repository.TicketRepository;
&nbsp;import com.example.techprototype.Service.SeatService;
&nbsp;import com.example.techprototype.Service.RedisService;
&nbsp;import com.example.techprototype.DAO.TicketInventoryDAO;
&nbsp;import org.springframework.amqp.rabbit.annotation.RabbitListener;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.time.LocalDate;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;@Component
<b class="fc">&nbsp;public class OrderProcessor {</b>
&nbsp;    
&nbsp;    @Autowired
&nbsp;    private OrderRepository orderRepository;
&nbsp;    
&nbsp;    @Autowired
&nbsp;    private TicketRepository ticketRepository;
&nbsp;    
&nbsp;    @Autowired
&nbsp;    private SeatService seatService;
&nbsp;    
&nbsp;    @Autowired
&nbsp;    private TicketInventoryDAO ticketInventoryDAO;
&nbsp;    
&nbsp;    @Autowired
&nbsp;    private RedisService redisService;
&nbsp;    
&nbsp;    @RabbitListener(queues = &quot;order.queue&quot;)
&nbsp;    @Transactional
&nbsp;    public void processOrder(OrderMessage orderMessage) {
<b class="fc">&nbsp;        System.out.println(&quot;收到订单消息: &quot; + orderMessage.getOrderNumber());</b>
&nbsp;        
&nbsp;        // 记录已创建的车票，用于异常时回滚
<b class="fc">&nbsp;        List&lt;Ticket&gt; createdTickets = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;        Order createdOrder = null;</b>
&nbsp;        
&nbsp;        try {
&nbsp;            // 1. 创建订单
<b class="fc">&nbsp;            Order order = new Order();</b>
<b class="fc">&nbsp;            order.setOrderNumber(orderMessage.getOrderNumber());</b>
<b class="fc">&nbsp;            order.setUserId(orderMessage.getUserId());</b>
<b class="fc">&nbsp;            order.setOrderTime(LocalDateTime.now());</b>
<b class="fc">&nbsp;            order.setOrderStatus((byte) OrderStatus.PENDING_PAYMENT.getCode());</b>
&nbsp;            
&nbsp;            // 计算总金额
<b class="fc">&nbsp;            BigDecimal totalAmount = calculateTotalAmount(orderMessage);</b>
<b class="fc">&nbsp;            order.setTotalAmount(totalAmount);</b>
&nbsp;            
<b class="fc">&nbsp;            orderRepository.save(order);</b>
<b class="fc">&nbsp;            createdOrder = order;</b>
<b class="fc">&nbsp;            System.out.println(&quot;订单创建成功: &quot; + order.getOrderNumber() + &quot;, ID: &quot; + order.getOrderId());</b>
&nbsp;            
&nbsp;            // 2. 创建车票记录（未支付状态）
<b class="fc">&nbsp;            List&lt;Ticket&gt; tickets = new ArrayList&lt;&gt;();</b>
&nbsp;            
<b class="fc">&nbsp;            for (OrderMessage.PassengerInfo passengerInfo : orderMessage.getPassengers()) {</b>
<b class="fc">&nbsp;                Ticket ticket = new Ticket();</b>
<b class="fc">&nbsp;                ticket.setTicketNumber(generateTicketNumber());</b>
<b class="fc">&nbsp;                ticket.setOrderId(order.getOrderId());</b>
<b class="fc">&nbsp;                ticket.setPassengerId(passengerInfo.getPassengerId());</b>
<b class="fc">&nbsp;                ticket.setTrainId(orderMessage.getTrainId());</b>
<b class="fc">&nbsp;                ticket.setDepartureStopId(orderMessage.getDepartureStopId());</b>
<b class="fc">&nbsp;                ticket.setArrivalStopId(orderMessage.getArrivalStopId());</b>
<b class="fc">&nbsp;                ticket.setTravelDate(orderMessage.getTravelDate());</b>
<b class="fc">&nbsp;                ticket.setCarriageTypeId(passengerInfo.getCarriageTypeId());</b>
&nbsp;                // 从库存表获取基础票价，然后根据票种计算优惠
<b class="fc">&nbsp;                BigDecimal ticketPrice = calculateTicketPrice(</b>
<b class="fc">&nbsp;                    orderMessage.getTrainId(),</b>
<b class="fc">&nbsp;                    orderMessage.getDepartureStopId(),</b>
<b class="fc">&nbsp;                    orderMessage.getArrivalStopId(),</b>
<b class="fc">&nbsp;                    orderMessage.getTravelDate(),</b>
<b class="fc">&nbsp;                    passengerInfo.getCarriageTypeId(),</b>
<b class="fc">&nbsp;                    passengerInfo.getTicketType()</b>
&nbsp;                );
<b class="fc">&nbsp;                ticket.setPrice(ticketPrice);</b>
<b class="fc">&nbsp;                ticket.setTicketStatus((byte) TicketStatus.PENDING.getCode());</b>
<b class="fc">&nbsp;                ticket.setTicketType(passengerInfo.getTicketType());</b>
<b class="fc">&nbsp;                ticket.setCreatedTime(LocalDateTime.now());</b>
&nbsp;                
&nbsp;                // 分配座位
<b class="fc">&nbsp;                seatService.assignSeat(ticket);</b>
&nbsp;                
<b class="fc">&nbsp;                tickets.add(ticket);</b>
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            ticketRepository.saveAll(tickets);</b>
<b class="fc">&nbsp;            createdTickets.addAll(tickets);</b>
<b class="fc">&nbsp;            System.out.println(&quot;车票创建成功: &quot; + tickets.size() + &quot;张&quot;);</b>
&nbsp;            
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            System.err.println(&quot;订单处理失败: &quot; + e.getMessage());</b>
<b class="fc">&nbsp;            e.printStackTrace();</b>
&nbsp;            
&nbsp;            // 回滚库存
<b class="fc">&nbsp;            rollbackInventory(orderMessage);</b>
&nbsp;            
&nbsp;            // 清理已创建的数据
<b class="fc">&nbsp;            cleanupCreatedData(createdTickets, createdOrder);</b>
&nbsp;            
&nbsp;            // 重新抛出异常，确保事务回滚
<b class="fc">&nbsp;            throw new RuntimeException(&quot;订单处理失败，已回滚库存: &quot; + e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    private BigDecimal calculateTotalAmount(OrderMessage orderMessage) {
<b class="fc">&nbsp;        BigDecimal totalAmount = BigDecimal.ZERO;</b>
&nbsp;        
<b class="fc">&nbsp;        for (OrderMessage.PassengerInfo passengerInfo : orderMessage.getPassengers()) {</b>
<b class="fc">&nbsp;            BigDecimal ticketPrice = calculateTicketPrice(</b>
<b class="fc">&nbsp;                orderMessage.getTrainId(),</b>
<b class="fc">&nbsp;                orderMessage.getDepartureStopId(),</b>
<b class="fc">&nbsp;                orderMessage.getArrivalStopId(),</b>
<b class="fc">&nbsp;                orderMessage.getTravelDate(),</b>
<b class="fc">&nbsp;                passengerInfo.getCarriageTypeId(),</b>
<b class="fc">&nbsp;                passengerInfo.getTicketType()</b>
&nbsp;            );
<b class="fc">&nbsp;            totalAmount = totalAmount.add(ticketPrice);</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        return totalAmount;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * 计算票价 - 从库存信息获取基础票价，然后根据票种计算优惠
&nbsp;     */
&nbsp;    private BigDecimal calculateTicketPrice(Integer trainId, Long departureStopId, Long arrivalStopId, 
&nbsp;                                          LocalDate travelDate, Integer carriageTypeId, Byte ticketType) {
&nbsp;        // 从库存信息获取基础票价
<b class="fc">&nbsp;        Optional&lt;TicketInventory&gt; inventory = ticketInventoryDAO.findByKey(trainId, departureStopId, arrivalStopId, travelDate, carriageTypeId);</b>
&nbsp;        
<b class="fc">&nbsp;        System.out.println(&quot;查询库存 - 车次:&quot; + trainId + &quot;, 出发站:&quot; + departureStopId + &quot;, 到达站:&quot; + arrivalStopId + </b>
<b class="fc">&nbsp;                          &quot;, 日期:&quot; + travelDate + &quot;, 车厢类型:&quot; + carriageTypeId + &quot;, 找到:&quot; + inventory.isPresent());</b>
&nbsp;        
<b class="fc">&nbsp;        if (inventory.isEmpty()) {</b>
<b class="fc">&nbsp;            System.out.println(&quot;未找到库存记录，使用默认票价100元&quot;);</b>
<b class="fc">&nbsp;            return BigDecimal.valueOf(100.0); // 默认票价</b>
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        BigDecimal basePrice = inventory.get().getPrice();</b>
<b class="fc">&nbsp;        System.out.println(&quot;找到库存记录，基础票价:&quot; + basePrice + &quot;元&quot;);</b>
&nbsp;        
&nbsp;        // 根据票种计算优惠
&nbsp;        BigDecimal finalPrice;
<b class="pc">&nbsp;        switch (ticketType) {</b>
&nbsp;            case 1: // 成人票 - 无优惠
<b class="fc">&nbsp;                finalPrice = basePrice;</b>
&nbsp;                break;
&nbsp;            case 2: // 儿童票 - 5折
<b class="fc">&nbsp;                finalPrice = basePrice.multiply(BigDecimal.valueOf(0.5));</b>
&nbsp;                break;
&nbsp;            case 3: // 学生票 - 8折
<b class="fc">&nbsp;                finalPrice = basePrice.multiply(BigDecimal.valueOf(0.8));</b>
&nbsp;                break;
&nbsp;            case 4: // 残疾票 - 5折
<b class="nc">&nbsp;                finalPrice = basePrice.multiply(BigDecimal.valueOf(0.5));</b>
&nbsp;                break;
&nbsp;            case 5: // 军人票 - 5折
<b class="nc">&nbsp;                finalPrice = basePrice.multiply(BigDecimal.valueOf(0.5));</b>
&nbsp;                break;
&nbsp;            default:
<b class="nc">&nbsp;                finalPrice = basePrice;</b>
&nbsp;                break;
&nbsp;        }
&nbsp;        
<b class="fc">&nbsp;        System.out.println(&quot;票种:&quot; + ticketType + &quot;, 最终票价:&quot; + finalPrice + &quot;元&quot;);</b>
<b class="fc">&nbsp;        return finalPrice;</b>
&nbsp;    }
&nbsp;    
&nbsp;    private String generateTicketNumber() {
<b class="fc">&nbsp;        return &quot;T&quot; + System.currentTimeMillis() + (int)(Math.random() * 1000);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * 回滚库存 - 当订单处理失败时，将Redis中的库存加回
&nbsp;     */
&nbsp;    private void rollbackInventory(OrderMessage orderMessage) {
&nbsp;        try {
<b class="fc">&nbsp;            System.out.println(&quot;开始回滚库存: &quot; + orderMessage.getOrderNumber());</b>
&nbsp;            
<b class="fc">&nbsp;            for (OrderMessage.PassengerInfo passengerInfo : orderMessage.getPassengers()) {</b>
<b class="fc">&nbsp;                boolean success = redisService.incrStock(</b>
<b class="fc">&nbsp;                    orderMessage.getTrainId(),</b>
<b class="fc">&nbsp;                    orderMessage.getDepartureStopId(),</b>
<b class="fc">&nbsp;                    orderMessage.getArrivalStopId(),</b>
<b class="fc">&nbsp;                    orderMessage.getTravelDate(),</b>
<b class="fc">&nbsp;                    passengerInfo.getCarriageTypeId(),</b>
&nbsp;                    1
&nbsp;                );
&nbsp;                
<b class="pc">&nbsp;                if (success) {</b>
<b class="fc">&nbsp;                    System.out.println(&quot;库存回滚成功: 车次&quot; + orderMessage.getTrainId() + </b>
<b class="fc">&nbsp;                                     &quot;, 席别&quot; + passengerInfo.getCarriageTypeId() + </b>
&nbsp;                                     &quot;, 数量+1&quot;);
&nbsp;                } else {
<b class="nc">&nbsp;                    System.err.println(&quot;库存回滚失败: 车次&quot; + orderMessage.getTrainId() + </b>
<b class="nc">&nbsp;                                     &quot;, 席别&quot; + passengerInfo.getCarriageTypeId());</b>
&nbsp;                }
&nbsp;            }
&nbsp;            
<b class="fc">&nbsp;            System.out.println(&quot;库存回滚完成: &quot; + orderMessage.getOrderNumber());</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            System.err.println(&quot;库存回滚异常: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * 清理已创建的数据 - 当订单处理失败时，清理已创建的订单和车票
&nbsp;     */
&nbsp;    private void cleanupCreatedData(List&lt;Ticket&gt; createdTickets, Order createdOrder) {
&nbsp;        try {
&nbsp;            // 删除已创建的车票
<b class="pc">&nbsp;            if (!createdTickets.isEmpty()) {</b>
<b class="nc">&nbsp;                ticketRepository.deleteAll(createdTickets);</b>
<b class="nc">&nbsp;                System.out.println(&quot;已删除 &quot; + createdTickets.size() + &quot; 张车票&quot;);</b>
&nbsp;            }
&nbsp;            
&nbsp;            // 删除已创建的订单
<b class="pc">&nbsp;            if (createdOrder != null) {</b>
<b class="nc">&nbsp;                orderRepository.delete(createdOrder);</b>
<b class="nc">&nbsp;                System.out.println(&quot;已删除订单: &quot; + createdOrder.getOrderNumber());</b>
&nbsp;            }
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            System.err.println(&quot;清理已创建数据失败: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
&nbsp;        }
&nbsp;    }
&nbsp;} 
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-19 00:00</div>
</div>
</body>
</html>
